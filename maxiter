#!/usr/bin/env php
<?php
// require __DIR__ . "/app/models/LoadModel.php";

class MaxiterConfiguration
{
    public function generateController($fileName)
    {
        $path = __DIR__ . '/app/controllers/' . $fileName . ".php";

        // Content to be written to the file
        $content = "<?php\n" .
            "/*\n" .
            "The controller file handles user input and interaction. It processes requests,\n" .
            "invokes business logic, and updates the model as needed.\n" .
            "\n" .
            "@author Victor Béser\n" .
            "*/\n" .
            "require __DIR__ . '/../models/LoadModel.php';\n" .
            "require __DIR__ . '/../models/SecureRequestModel.php';\n\n" .
            "class " . ucfirst($fileName) . " {\n\n" .
            "    public function main() {\n" .
            "        // Your code here\n" .
            "    }\n\n" .
            "}\n\n" .
            "\$controller = new " . ucfirst($fileName) . "();\n" .
            "(isset(\$_POST['controller']) && !empty(\$_POST['controller'])) ? \$controller->{\$_POST['controller']}() : \$controller->main();\n";

        // Create the /app directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app');
        // Create the /app/controllers directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app/controllers');

        // Check if the file already exists
        if (file_exists($path)) {
            echo "This controller already exists\n";
        } else {
            // Create the file and write the content
            file_put_contents($path, $content);
            echo "Controller $fileName created\n";
        }
    }

    public function generatePage($fileName, $baseContent = null)
    {
        $path = __DIR__ . '/resources/views/pages/' . $fileName . '/' . $fileName . ".php";
        $cssPath = __DIR__ . '/resources/views/pages/' . $fileName . '/css/' . $fileName . '.css';
        $jsPath = __DIR__ . '/resources/views/pages/' . $fileName . '/js/' . $fileName . '.js';

        // Content to be written to the PHP file
        if ($baseContent == null) {
            $content =
                "<!-- \n" .
                "This is your new page, it's already routed in Maxiter application\n" .
                "and everything you need is included here.\n" .
                "Happy Coding!\n" .
                "\n" .
                "@author Victor Béser\n" .
                "-->\n" .
                '<?php include __DIR__ . "/../_header/header.php"; ?>' . "\n" .
                "<!-- Page Title -->\n" .
                '<?php PagesTitleModel::title("Maxiter - ' . ucfirst($fileName) . '"); ?>' . "\n" .
                '<link rel="stylesheet" href="<?php echo EnvModel::env("APP_BASE_URL") ?>/resources/views/pages/' . $fileName . '/css/' . $fileName . '.css">' . "\n" .
                "<!--**********************************\n" .
                "        Main wrapper start\n" .
                "***********************************-->\n" .
                '<div id="main-wrapper">' . "\n" .
                "\n" .
                "    <!-- NAVBAR -->\n" .
                '    <?php include __DIR__ . "/../_navbar/navbar.php"; ?>' . "\n" .
                "    <!-- NAVBAR -->\n" .
                "\n" .
                "    <!-- SIDEBAR -->\n" .
                '    <?php include __DIR__ . "/../_sidenav/sidenav.php"; ?>' . "\n" .
                "    <!-- SIDEBAR -->\n" .
                "\n" .
                "    <!--**********************************\n" .
                "            Content body start\n" .
                "        ***********************************-->\n" .
                '    <div class="content-body">' . "\n" .
                "        <!-- row -->\n" .
                "        <div class=\"container-fluid\">" . "\n" .
                "\n" .
                "            <!-- CARDS -->\n" .
                '            <?php include __DIR__ . "/../_cards/cards.php"; ?>' . "\n" .
                "            <!-- CARDS -->\n" .
                "\n" .
                "            <div class=\"row\">" . "\n" .
                "                <div class=\"col-xl-12 col-lg-8 col-md-8\">" . "\n" .
                "                    <div class=\"card\">" . "\n" .
                "                        <div class=\"card-header\">" . "\n" .
                "                            <h4 class=\"card-title\"><?php echo EnvModel::env(\"APP_NAME\") ?> - " . ucfirst($fileName) . "</h4>\n" .
                "                        </div>" . "\n" .
                "                        <div class=\"card-body\">" . "\n" .
                "                            <div class=\"row\">" . "\n" .
                "                                <div style=\"text-align:justify;\" class=\"col-xl-12 col-lg-8\">" . "\n" .
                "                                    <!-- CODE HERE HERE -->\n\n" .
                "                                </div>" . "\n" .
                "                            </div>" . "\n" .
                "                        </div>" . "\n" .
                "                    </div>" . "\n" .
                "                </div>" . "\n" .
                "\n" .
                "            </div>" . "\n" .
                "\n" .
                "        </div>" . "\n" .
                "    </div>" . "\n" .
                "    <!--**********************************\n" .
                "            Content body end\n" .
                "        ***********************************-->\n" .
                "\n" .
                "</div>" . "\n" .
                "<!--**********************************\n" .
                "        Main wrapper end\n" .
                "    ***********************************-->" . "\n" .
                "\n" .
                '<script src="<?php echo EnvModel::env("APP_BASE_URL") ?>resources/views/pages/' . $fileName . '/js/' . $fileName . '.js"></script>' . "\n" .
                '<?php include __DIR__ . "/../_footer/footer.php"; ?>';
        }


        $this->createDirectory(__DIR__ . '/resources');
        $this->createDirectory(__DIR__ . '/resources/views');
        $this->createDirectory(__DIR__ . '/resources/views/pages');
        $this->createDirectory(__DIR__ . '/resources/views/pages/' . $fileName . '/');
        $this->createDirectory(__DIR__ . '/resources/views/pages/' . $fileName . '/css/');
        $this->createDirectory(__DIR__ . '/resources/views/pages/' . $fileName . '/js/');

        // Check if the PHP file already exists
        if (file_exists($path)) {
            echo "This page already exists\n";
        } else {
            // Create the PHP file and write the content

            if ($baseContent == null) {
                file_put_contents($path, $content);
            } else if ($baseContent != null) {
                $indexFile = __DIR__ . "\\src\\template\\$baseContent\\index.html";

                // Check if the index file exists
                if (file_exists($indexFile)) {
                    // Read the content of index.html
                    $fileContent = file_get_contents($indexFile);

                    // Use regular expression to extract content between @header markers
                    if (preg_match('/@body(.*?)@body/s', $fileContent, $matches)) {
                        // $matches[1] will contain the content between the @header markers

                        // Create the body.php file and write the extracted content
                        $bodyFile = __DIR__ . "\\resources\\views\\pages\\$fileName\\$fileName.php";
                        if (file_put_contents($path, $matches[1])) {
                            echo "Page $fileName will be created using the index.html with @body tag as content.\n";
                        } else {
                            echo "Failed to create $fileName.php file.\n";
                        }
                    } else {
                        echo "No content found between @body markers.\n";
                    }
                } else {
                    echo "The index.html file does not exist.\n";
                }
            }

            echo "Page $fileName created\n";
        }

        // Content for the CSS file
        $cssContent = "/* Styles for $fileName page */\n";
        file_put_contents($cssPath, $cssContent);
        echo "CSS file $fileName.css created\n";

        // Content for the JS file
        $jsContent = "// JavaScript for $fileName page\n";
        file_put_contents($jsPath, $jsContent);
        echo "JS file $fileName.js created\n";

        // FINAL CONFIGURATIONS CHANGING TAGS WITH PATH VAR
        if ($baseContent != null) {
            // PAGE
            $page = __DIR__ . "\\resources\\views\\pages\\$fileName\\$fileName.php";
            // The content to prepend
            $preContent = "<?php include __DIR__ . '/../_header/header.php'; ?>\n
<!-- Page Title -->\n
<?php PagesTitleModel::title('Maxiter - $fileName Page'); ?>\n
<link rel='stylesheet' href='<?php echo EnvModel::env('APP_BASE_URL') ?>resources/views/pages/$fileName/css/$fileName.css'>\n";
            // Check if the $fileName.php file exists
            if (file_exists($page)) {
                // Read the current content of the file
                $currentContent = file_get_contents($page);

                // Prepend the new content to the existing content
                $newContent = $preContent . $currentContent;

                // Write the new content back to the file
                if (file_put_contents($page, $newContent)) {
                    echo "Successfully added the configuration at the beginning of $fileName.php.\n";
                } else {
                    echo "Failed to update $fileName.php.\n";
                }
            } else {
                echo "The $fileName.php file does not exist.\n";
            }
            // The content to append
            $appendContent = "<script src='<?php echo EnvModel::env('APP_BASE_URL') ?>resources/views/pages/$fileName/js/$fileName.js'></script>\n
<?php include __DIR__ . '/../_footer/footer.php'; ?>";

            // Check if the $fileName.php file exists
            if (file_exists($page)) {
                // Read the current content of the file
                $currentContent = file_get_contents($page);

                // Append the new content to the existing content
                $newContent = $currentContent . $appendContent;

                // Write the new content back to the file
                if (file_put_contents($page, $newContent)) {
                    echo "Successfully added the configuration at the end of $fileName.php.\n";
                } else {
                    echo "Failed to update $fileName.php.\n";
                }
            } else {
                echo "The $fileName.php file does not exist.\n";
            }

            // All SRC or URL IMAGE HOMEPAGE
            // Check if the home.php file exists
            if (file_exists($page)) {
                // Read the current content of the file
                $content = file_get_contents($page);

                // Regular expression to find and modify img src paths
                $content = preg_replace_callback('/<img[^>]*src=["\']([^"\']+)["\']/i', function ($matches) {
                    $originalSrc = $matches[1];  // The original src value
                    // Check if the path is relative (i.e., not starting with "http" or "//")
                    if (strpos($originalSrc, 'http') === false && strpos($originalSrc, '//') === false) {
                        // Prepend the base URL and resources/views/ to the src path
                        $modifiedSrc = '<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalSrc;
                        return str_replace($originalSrc, $modifiedSrc, $matches[0]);
                    }
                    // If the src is already an absolute URL, return it unchanged
                    return $matches[0];
                }, $content);

                // Regular expression to find and modify background-image url() paths
                $content = preg_replace_callback('/background-image:\s*url\(["\']?([^"\')]+)["\']?\)/i', function ($matches) {
                    $originalUrl = $matches[1];  // The original URL in the background-image
                    // Check if the path is relative
                    if (strpos($originalUrl, 'http') === false && strpos($originalUrl, '//') === false) {
                        // Prepend the base URL and resources/views/ to the background-image URL
                        $modifiedUrl = 'url(<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalUrl . ')';
                        // Replace only the part inside the url() function with the modified URL
                        return preg_replace('/url\(["\']?([^"\')]+)["\']?\)/', $modifiedUrl, $matches[0]);
                    }
                    // If the URL is already absolute, return it unchanged
                    return $matches[0];
                }, $content);

                // Regular expression to find and modify img src paths
                $content = preg_replace_callback('/<source[^>]*src=["\']([^"\']+)["\']/i', function ($matches) {
                    $originalSrc = $matches[1];  // The original src value
                    // Check if the path is relative (i.e., not starting with "http" or "//")
                    if (strpos($originalSrc, 'http') === false && strpos($originalSrc, '//') === false) {
                        // Prepend the base URL and resources/views/ to the src path
                        $modifiedSrc = '<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalSrc;
                        return str_replace($originalSrc, $modifiedSrc, $matches[0]);
                    }
                    // If the src is already an absolute URL, return it unchanged
                    return $matches[0];
                }, $content);

                // Write the modified content back to the file
                if (file_put_contents($page, $content)) {
                    echo "Successfully updated the src and background-image paths in $fileName.php.\n";
                } else {
                    echo "Failed to update the $fileName.php file.\n";
                }
            } else {
                echo "The $fileName.php file does not exist.\n";
            }
        }

        echo "Note that this is not 100% perfect due the massive exceptions we get when different types of devs create different templates many different ways, please check out the src, href, and stuff.";
    }

    public function generateModel($fileName)
    {
        $path = __DIR__ . '/app/models/' . $fileName . ".php";

        // Conteúdo do model a ser criado
        $content = "<?php\n" .
            "/*\n" .
            "The model represents the application's data and business logic. It manages data retrieval, \n" .
            "storage, and manipulation, often interacting with the database. \n" .
            "The model encapsulates rules and validation to ensure data integrity.\n" .
            "\n" .
            "@author Victor Béser\n" .
            "*/\n" .
            "class " . ucfirst($fileName) . " {\n\n" .
            "    public static function main() {\n" .
            "        // Your code here\n" .
            "    }\n\n" .
            "}";

        $this->createDirectory(__DIR__ . '/app');
        $this->createDirectory(__DIR__ . '/app/models');

        if (file_exists($path)) {
            echo "This model already exists\n";
        } else {
            file_put_contents($path, $content);
            echo "Model $fileName created\n";

            $loadModelPath = __DIR__ . '/app/models/LoadModel.php';
            if (file_exists($loadModelPath) && is_writable($loadModelPath)) {
                $loadModelContent = file_get_contents($loadModelPath);

                $newRequireLine = 'require __DIR__ . "/' . ucfirst($fileName) . '.php";';

                if (strpos($loadModelContent, $newRequireLine) === false) {

                    $pattern = '/(require\s+__DIR__\s*\.\s*".*?\.php";\s*)$/m';

                    if (preg_match_all($pattern, $loadModelContent, $matches, PREG_OFFSET_CAPTURE)) {
                        $lastMatch = end($matches[0]);
                        $pos = $lastMatch[1] + strlen($lastMatch[0]);

                        $loadModelContent = substr_replace(
                            $loadModelContent,
                            "\n" . $newRequireLine,
                            $pos,
                            0
                        );

                        file_put_contents($loadModelPath, $loadModelContent);

                        echo "Added $fileName require to LoadModel.php\n";
                    } else {
                        echo "Could not find the last require statement to append new model require.\n";
                    }
                } else {
                    echo "Require statement for $fileName already exists in LoadModel.php\n";
                }
            } else {
                echo "LoadModel.php not found or not writable\n";
            }
        }
    }


    public function generateLogModel($database)
    {
        $path = __DIR__ . '/app/models/LogModel.php';

        if (!isset($database) || empty($database)) {
            echo "Error: php maxiter new log [database]";
            exit();
        }

        // Content to be written to the file
        $content = "<?php\n" .
            "/*\n" .
            "This is the log file, use it statically where you want using LogModel::log(\"Your log text here\")\n" .
            "\n" .
            "@author Victor Béser\n" .
            "*/\n" .
            "class LogModel {\n\n" .
            "    private static \$log;\n" .
            "    public static function log(\$log) {\n" .
            "        \$currentDateTime = new DateTime();\n" .
            "        \$formattedDateTime = \$currentDateTime->format('Y-m-d H:i:s');\n\n" .
            "        self::\$log = mb_strtoupper(\$log);\n\n" .
            "        \$query = \"INSERT INTO logs (log, created_at) VALUES (:log, :date)\";\n" .
            "        \$result = DatabaseModel::connection(\"$database\")->execute(\$query, [\n" .
            "            \":log\" => self::\$log,\n" .
            "            \":date\" => \$formattedDateTime,\n" .
            "        ]);\n" .
            "    }\n\n" .
            "}";

        // Create the /app directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app');
        // Create the /app/models directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app/models');

        // Check if the file already exists
        if (file_exists($path)) {
            echo "This model already exists\n";
        } else {
            // Create the file and write the content
            file_put_contents($path, $content);
            echo "LogModel with database '$database' created\n";
        }
    }

    public function generateSQL($table)
    {

        $path = __DIR__ . '/src/tables/' . $table . '.sql';

        switch ($table) {

            case 'users':
                $content = "-- Create the users table\n" .
                    "CREATE TABLE users (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY,\n" .
                    "    username VARCHAR(50) NOT NULL UNIQUE,\n" .
                    "    password VARCHAR(255) NOT NULL,\n" .
                    "    email VARCHAR(100) NOT NULL UNIQUE,\n" .
                    "    first_name VARCHAR(50),\n" .
                    "    last_name VARCHAR(50),\n" .
                    "    phone_number VARCHAR(15),\n" .
                    "    address VARCHAR(255),\n" .
                    "    city VARCHAR(50),\n" .
                    "    state VARCHAR(50),\n" .
                    "    zip_code VARCHAR(10),\n" .
                    "    country VARCHAR(50),\n" .
                    "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n" .
                    "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n" .
                    ");\n\n" .
                    "-- Insert data into the users table\n" .
                    "INSERT INTO users (username, password, email, first_name, last_name, phone_number, address, city, state, zip_code, country) VALUES\n" .
                    "('johndoe', MD5('password123'), 'johndoe@example.com', 'John', 'Doe', '1234567890', '123 Main St', 'Anytown', 'Anystate', '12345', 'USA'),\n" .
                    "('janedoe', MD5('mypassword'), 'janedoe@example.com', 'Jane', 'Doe', '0987654321', '456 Elm St', 'Othertown', 'Otherstate', '54321', 'USA'),\n" .
                    "('alice', MD5('alicepassword'), 'alice@example.com', 'Alice', 'Smith', '1112223333', '789 Maple Ave', 'Sometown', 'Somestate', '67890', 'USA'),\n" .
                    "('bob', MD5('bobpassword'), 'bob@example.com', 'Bob', 'Johnson', '4445556666', '321 Oak St', 'Differenttown', 'Differentstate', '09876', 'USA');";
                break;

            case 'logs':
                $content = "-- Create the logs table\n" .
                    "CREATE TABLE logs (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY,\n" .
                    "    log TEXT NOT NULL,\n" .
                    "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n" .
                    ");\n\n" .
                    "-- Insert data into the logs table\n" .
                    "INSERT INTO logs (log) VALUES\n" .
                    "('User johndoe logged in successfully'),\n" .
                    "('User janedoe attempted to access restricted area'),\n" .
                    "('User alice updated profile information'),\n" .
                    "('User bob logged out');";
                break;


            case 'products':
                $content = "-- Create the products table\n" .
                    "CREATE TABLE products (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY,\n" .
                    "    name VARCHAR(100) NOT NULL,\n" .
                    "    description TEXT,\n" .
                    "    price DECIMAL(10, 2) NOT NULL,\n" .
                    "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n" .
                    "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n" .
                    ");\n\n" .
                    "-- Insert data into the products table\n" .
                    "INSERT INTO products (name, description, price) VALUES\n" .
                    "('Product 1', 'Description for Product 1', 19.99),\n" .
                    "('Product 2', 'Description for Product 2', 29.99),\n" .
                    "('Product 3', 'Description for Product 3', 39.99),\n" .
                    "('Product 4', 'Description for Product 4', 49.99);";
                break;

            case 'orders':
                $content = "-- Create the orders table\n" .
                    "CREATE TABLE orders (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY,\n" .
                    "    user_id INT NOT NULL,\n" .
                    "    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n" .
                    "    status VARCHAR(50) NOT NULL,\n" .
                    "    total DECIMAL(10, 2) NOT NULL,\n" .
                    "    FOREIGN KEY (user_id) REFERENCES users(id)\n" .
                    ");\n\n" .
                    "-- Insert data into the orders table\n" .
                    "INSERT INTO orders (user_id, status, total) VALUES\n" .
                    "(1, 'Pending', 59.98),\n" .
                    "(2, 'Completed', 29.99),\n" .
                    "(1, 'Shipped', 39.99),\n" .
                    "(3, 'Cancelled', 19.99);";
                break;

            case 'customers':
                $content = "-- Create the customers table\n" .
                    "CREATE TABLE customers (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY,\n" .
                    "    name VARCHAR(100) NOT NULL,\n" .
                    "    email VARCHAR(100) NOT NULL UNIQUE,\n" .
                    "    phone_number VARCHAR(15),\n" .
                    "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n" .
                    "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n" .
                    ");\n\n" .
                    "-- Insert data into the customers table\n" .
                    "INSERT INTO customers (name, email, phone_number) VALUES\n" .
                    "('Alice Smith', 'alice@example.com', '1234567890'),\n" .
                    "('Bob Johnson', 'bob@example.com', '0987654321'),\n" .
                    "('Charlie Brown', 'charlie@example.com', '5551234567'),\n" .
                    "('Diana Prince', 'diana@example.com', '4449876543');";
                break;

            case 'roles':
                $content = "-- Create the roles table\n" .
                    "CREATE TABLE roles (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY,\n" .
                    "    role_name VARCHAR(50) NOT NULL UNIQUE,\n" .
                    "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n" .
                    "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n" .
                    ");\n\n" .
                    "-- Insert data into the roles table\n" .
                    "INSERT INTO roles (role_name) VALUES\n" .
                    "('Admin'),\n" .
                    "('Editor'),\n" .
                    "('Viewer'),\n" .
                    "('Guest');";
                break;

            case 'permissions':
                $content = "-- Create the permissions table\n" .
                    "CREATE TABLE permissions (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY,\n" .
                    "    permission_name VARCHAR(50) NOT NULL UNIQUE,\n" .
                    "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n" .
                    "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n" .
                    ");\n\n" .
                    "-- Insert data into the permissions table\n" .
                    "INSERT INTO permissions (permission_name) VALUES\n" .
                    "('Create'),\n" .
                    "('Read'),\n" .
                    "('Update'),\n" .
                    "('Delete');";
                break;

            default:
                $content = "-- Create the $table table\n" .
                    "CREATE TABLE $table (\n" .
                    "    id INT AUTO_INCREMENT PRIMARY KEY NOT NULL\n" .
                    ");";
                break;
        }


        // Create the /app directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/src');
        // Create the /app/models directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/src/tables');

        // Check if the file already exists
        if (file_exists($path)) {
            echo "This table already exists\n";
        } else {
            // Create the file and write the content
            file_put_contents($path, $content);
            echo "Table '$table' created in path /src/tables/\n";
        }
    }

    public function initServer($port = null)
    {
        if ($port === null) {
            $url = "http://localhost:7000";  // A URL que você quer abrir

            if (strncasecmp(PHP_OS, 'WIN', 3) == 0) {
                // Windows: usa o comando 'start' para abrir a URL
                exec("start " . $url);
            } elseif (strncasecmp(PHP_OS, 'Linux', 5) == 0) {
                // Linux: usa o comando 'xdg-open' para abrir a URL
                exec("xdg-open " . $url);
            } elseif (strncasecmp(PHP_OS, 'Darwin', 6) == 0) {
                // macOS: usa o comando 'open' para abrir a URL
                exec("open " . $url);
            } else {
                echo "Sistema operacional não suportado para abrir URLs automaticamente.";
            }
            exec("php -S localhost:7000");
        } else {
            $url = "http://localhost:$port";  // A URL que você quer abrir

            if (strncasecmp(PHP_OS, 'WIN', 3) == 0) {
                // Windows: usa o comando 'start' para abrir a URL
                exec("start " . $url);
            } elseif (strncasecmp(PHP_OS, 'Linux', 5) == 0) {
                // Linux: usa o comando 'xdg-open' para abrir a URL
                exec("xdg-open " . $url);
            } elseif (strncasecmp(PHP_OS, 'Darwin', 6) == 0) {
                // macOS: usa o comando 'open' para abrir a URL
                exec("open " . $url);
            } else {
                echo "Sistema operacional não suportado para abrir URLs automaticamente.";
            }
            exec("php -S localhost:$port");
        }
    }

    public function initGUI()
    {
        $env = parse_ini_file("./env.ini", true);
        $path = $env["app"]["APP_BASE_URL"];
        echo "Do not forget to set your correct app base url using ' php maxiter path [path] ', using: $path";
        exec("start $path" . "gui.html");
    }

    public function setPath($pathUrl)
    {

        $pathUrl = rtrim($pathUrl, '/') . '/';

        $env_ini = './env.ini';
        $lines = file($env_ini, FILE_IGNORE_NEW_LINES);
        foreach ($lines as $key => $line) {
            if (strpos($line, 'APP_BASE_URL') !== false) {
                $lines[$key] = 'APP_BASE_URL="' . $pathUrl . '"';
                break;
            }
        }

        $path_js = './path.js';
        $lines_js = file($path_js, FILE_IGNORE_NEW_LINES);
        foreach ($lines_js as $key => $line) {
            if (strpos($line, 'APP_BASE_URL') !== false) {
                $lines_js[$key] = 'APP_BASE_URL:"' . $pathUrl . '"';
                break;
            }
        }

        file_put_contents($env_ini, implode(PHP_EOL, $lines));
        file_put_contents($path_js, implode(PHP_EOL, $lines_js));
        echo "New project base url set: $pathUrl";
    }

    public function autoSetUpPath($port = null)
    {
        $cwd = getcwd();
        $hostname = 'localhost';

        $commonPorts = [
            80,
            90,
            3000,
            3001,
            4200,
            5000,
            5173,
            5500,
            6000,
            7000,
            8000,
            8001,
            8080,
            8081,
            8888,
            9000,
            9090
        ];

        $openPort = $port;

        if ($openPort === null) {
            foreach ($commonPorts as $testPort) {
                $fp = @fsockopen($hostname, $testPort, $errno, $errstr, 0.1);
                if ($fp) {
                    fclose($fp);
                    $openPort = $testPort;
                    break;
                }
            }
            if ($openPort === null) {
                $openPort = 80;
            }
        }

        $docRootCandidates = ['htdocs', 'www', 'public_html'];
        $docRoot = null;
        foreach ($docRootCandidates as $candidate) {
            $pos = strpos($cwd, $candidate);
            if ($pos !== false) {
                $docRoot = substr($cwd, 0, $pos + strlen($candidate));
                break;
            }
        }

        if ($docRoot === null) {
            $docRoot = dirname(dirname($cwd));
        }

        $relativePath = trim(str_replace($docRoot, '', $cwd), '/');
        $relativePath = str_replace('\\', '/', $relativePath); // <-- esta linha nova


        $url = "http://$hostname";
        if ($openPort != 80) {
            $url .= ":$openPort";
        }
        if (!empty($relativePath)) {
            $url .= '/' . ltrim($relativePath, '/');
        }


        echo "Auto path $url will be set as your main path\n";

        $this->setPath($url);
    }



    // ############################################################################ //
    // ############################################################################ //
    // ############################ SET NEW TEMPLATE ############################## //
    // ############################################################################ //
    // ############################################################################ //

    public function setNewTemplate($templateFolder)
    {
        // Folder paths
        $viewsFolder = __DIR__ . "\\resources\\views";  // Destination folder
        $templateFolder = __DIR__ . "\\src\\template\\$templateFolder";  // Template source folder
        $indexFile = $templateFolder . "\\index.html";

        // Remove the views folder if it exists
        echo "Removing views folder...\n";
        if (is_dir($viewsFolder)) {
            // Check if the system is Windows or Unix-like (Linux/Mac)
            if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
                // Use the command to remove the folder on Windows
                exec("rd /s /q \"$viewsFolder\"");
            } else {
                // Use the command to remove the folder on Linux/Mac
                exec("rm -rf \"$viewsFolder\"");
            }
        } else {
            echo "Views folder not found.\n";
        }

        // Check if the folder was successfully removed
        if (!is_dir($viewsFolder)) {
            echo "Views folder removed successfully or not found.\n";
        } else {
            echo "Failed to remove views folder.\n";
        }

        // Recreate the views folder
        echo "Creating views folder...\n";
        if (mkdir($viewsFolder, 0777, true)) {
            echo "Views folder created successfully.\n";
        } else {
            echo "Failed to create views folder.\n";
            return;
        }

        // Check if the source folder exists
        if (is_dir($templateFolder)) {
            // Get the files from the template
            $files = scandir($templateFolder);

            // Iterate over the files in the source folder
            foreach ($files as $file) {
                // Ignore the entries "." and ".."
                if ($file != '.' && $file != '..') {
                    $sourcePath = $templateFolder . '\\' . $file; // Full path of the source file
                    $destinationPath = $viewsFolder . '\\' . $file; // Full path of the destination file

                    // Check if it's a directory (subfolder) and copy the subfolder and its files
                    if (is_dir($sourcePath)) {
                        // Create the subfolder in the destination, if it doesn't exist
                        if (!is_dir($destinationPath)) {
                            mkdir($destinationPath, 0777, true);
                        }
                        echo "Subfolder '$file' copied successfully!\n";

                        // Copy all files and subfolders within the subfolder
                        $this->copyDirectoryContents($sourcePath, $destinationPath);
                    }
                }
            }
        } else {
            echo "The source folder '$templateFolder' does not exist.\n";
        }


        // Create pages folder and subfolders
        $pagesFolder = __DIR__ . "\\resources\\views\\pages";
        echo "Creating pages folder...\n";
        if (mkdir($pagesFolder, 0777, true)) {
            echo "Pages folder created successfully.\n";
        } else {
            echo "Failed to create Pages folder.\n";
            return;
        }
        // _header
        $headerFolder = __DIR__ . "\\resources\\views\\pages\\_header";
        echo "Creating _header component...\n";
        if (!is_dir($headerFolder)) {
            if (mkdir($headerFolder, 0777, true)) {
                echo "_header component created successfully.\n";
            } else {
                echo "Failed to create _header component.\n";
            }
        } else {
            echo "_header component already exists.\n";
        }

        // _footer
        $footerFolder = __DIR__ . "\\resources\\views\\pages\\_footer";
        echo "Creating _footer component...\n";
        if (!is_dir($footerFolder)) {
            if (mkdir($footerFolder, 0777, true)) {
                echo "_footer component created successfully.\n";
            } else {
                echo "Failed to create _footer component.\n";
            }
        } else {
            echo "_footer component already exists.\n";
        }

        // _navbar
        $navbarFolder = __DIR__ . "\\resources\\views\\pages\\_navbar";
        echo "Creating _navbar component...\n";
        if (!is_dir($navbarFolder)) {
            if (mkdir($navbarFolder, 0777, true)) {
                echo "_navbar component created successfully.\n";
            } else {
                echo "Failed to create _navbar component.\n";
            }
        } else {
            echo "_navbar component already exists.\n";
        }

        // _sidebar
        $sidebarFolder = __DIR__ . "\\resources\\views\\pages\\_sidebar";
        echo "Creating _sidebar component...\n";
        if (!is_dir($sidebarFolder)) {
            if (mkdir($sidebarFolder, 0777, true)) {
                echo "_sidebar component created successfully.\n";
            } else {
                echo "Failed to create _sidebar component.\n";
            }
        } else {
            echo "_sidebar component already exists.\n";
        }

        // home
        $homeFolder = __DIR__ . "\\resources\\views\\pages\\home";
        echo "Creating home folder...\n";
        if (!is_dir($homeFolder)) {
            if (mkdir($homeFolder, 0777, true)) {
                echo "Home folder created successfully.\n";
            } else {
                echo "Failed to create Home folder.\n";
            }
        } else {
            echo "Home folder already exists.\n";
        }

        // Creating files and content
        // Path to the index.html template file
        // $indexFile = $templateFolder . "\\index.html";

        // _header folder path
        $headerFolder = __DIR__ . "\\resources\\views\\pages\\_header";

        // Check if the index file exists
        if (file_exists($indexFile)) {
            // Read the content of index.html
            $fileContent = file_get_contents($indexFile);

            // Use regular expression to extract content between @header markers
            if (preg_match('/@header(.*?)@header/s', $fileContent, $matches)) {
                // $matches[1] will contain the content between the @header markers

                // Create the _header folder if it doesn't exist
                if (!is_dir($headerFolder)) {
                    if (mkdir($headerFolder, 0777, true)) {
                        echo "_header folder created successfully.\n";
                    } else {
                        echo "Failed to create _header folder.\n";
                    }
                }

                // Create the header.php file and write the extracted content
                $headerFile = $headerFolder . "\\header.php";
                if (file_put_contents($headerFile, $matches[1])) {
                    echo "header.php file created successfully inside the _header folder.\n";
                } else {
                    echo "Failed to create header.php file.\n";
                }
            } else {
                echo "No content found between @header markers.\n";
            }
        } else {
            echo "The index.html file does not exist.\n";
        }



        // _footer folder path
        $footerFolder = __DIR__ . "\\resources\\views\\pages\\_footer";

        // Check if the index file exists
        if (file_exists($indexFile)) {
            // Read the content of index.html
            $fileContent = file_get_contents($indexFile);

            // Use regular expression to extract content between @header markers
            if (preg_match('/@footer(.*?)@footer/s', $fileContent, $matches)) {
                // $matches[1] will contain the content between the @header markers

                // Create the _header folder if it doesn't exist
                if (!is_dir($footerFolder)) {
                    if (mkdir($footerFolder, 0777, true)) {
                        echo "_footer folder created successfully.\n";
                    } else {
                        echo "Failed to create _footer folder.\n";
                    }
                }

                // Create the footer.php file and write the extracted content
                $footerFile = $footerFolder . "\\footer.php";
                if (file_put_contents($footerFile, $matches[1])) {
                    echo "footer.php file created successfully inside the _footer folder.\n";
                } else {
                    echo "Failed to create footer.php file.\n";
                }
            } else {
                echo "No content found between @footer markers.\n";
            }
        } else {
            echo "The index.html file does not exist.\n";
        }



        // _navbar folder path
        $navbarFolder = __DIR__ . "\\resources\\views\\pages\\_navbar";

        // Check if the index file exists
        if (file_exists($indexFile)) {
            // Read the content of index.html
            $fileContent = file_get_contents($indexFile);

            // Use regular expression to extract content between @header markers
            if (preg_match('/@navbar(.*?)@navbar/s', $fileContent, $matches)) {
                // $matches[1] will contain the content between the @header markers

                // Create the _header folder if it doesn't exist
                if (!is_dir($navbarFolder)) {
                    if (mkdir($navbarFolder, 0777, true)) {
                        echo "_navbar folder created successfully.\n";
                    } else {
                        echo "Failed to create _navbar folder.\n";
                    }
                }

                // Create the navbar.php file and write the extracted content
                $navbarFile = $navbarFolder . "\\navbar.php";
                if (file_put_contents($navbarFile, $matches[1])) {
                    echo "navbar.php file created successfully inside the _navbar folder.\n";
                } else {
                    echo "Failed to create navbar.php file.\n";
                }
            } else {
                echo "No content found between @navbar markers.\n";
            }
        } else {
            echo "The index.html file does not exist.\n";
        }

        // _sidebar folder path
        $sidebarFolder = __DIR__ . "\\resources\\views\\pages\\_sidebar";

        // Check if the index file exists
        if (file_exists($indexFile)) {
            // Read the content of index.html
            $fileContent = file_get_contents($indexFile);

            // Use regular expression to extract content between @header markers
            if (preg_match('/@sidebar(.*?)@sidebar/s', $fileContent, $matches)) {
                // $matches[1] will contain the content between the @header markers

                // Create the _header folder if it doesn't exist
                if (!is_dir($sidebarFolder)) {
                    if (mkdir($sidebarFolder, 0777, true)) {
                        echo "_sidebar folder created successfully.\n";
                    } else {
                        echo "Failed to create _sidebar folder.\n";
                    }
                }

                // Create the sidebar.php file and write the extracted content
                $sidebarFile = $sidebarFolder . "\\sidebar.php";
                if (file_put_contents($sidebarFile, $matches[1])) {
                    echo "sidebar.php file created successfully inside the _sidebar folder.\n";
                } else {
                    echo "Failed to create sidebar.php file.\n";
                }
            } else {
                echo "No content found between @sidebar markers.\n";
            }
        } else {
            echo "The index.html file does not exist.\n";
        }


        // _body folder path
        $bodyFolder = __DIR__ . "\\resources\\views\\pages\\home";

        // Check if the index file exists
        if (file_exists($indexFile)) {
            // Read the content of index.html
            $fileContent = file_get_contents($indexFile);

            // Use regular expression to extract content between @header markers
            if (preg_match('/@body(.*?)@body/s', $fileContent, $matches)) {
                // $matches[1] will contain the content between the @header markers

                // Create the _header folder if it doesn't exist
                if (!is_dir($bodyFolder)) {
                    if (mkdir($bodyFolder, 0777, true)) {
                        echo "Home folder created successfully.\n";
                    } else {
                        echo "Failed to create Home folder.\n";
                    }
                }

                // Create the body.php file and write the extracted content
                $bodyFile = $bodyFolder . "\\home.php";
                if (file_put_contents($bodyFile, $matches[1])) {
                    echo "home.php file created successfully inside the home folder.\n";
                } else {
                    echo "Failed to create home.php file.\n";
                }
            } else {
                echo "No content found between @body markers.\n";
            }
        } else {
            echo "The index.html file does not exist.\n";
        }

        // home JS folder creation
        $homeFolder = __DIR__ . "\\resources\\views\\pages\\home\\js";
        echo "Creating Home JS file file...\n";
        if (!is_dir($homeFolder)) {
            if (mkdir($homeFolder, 0777, true)) {
                echo "Home JS file created successfully.\n";
            } else {
                echo "Failed to create Home JS file.\n";
            }
        } else {
            echo "Home JS file already exists.\n";
        }
        // home JS folder path
        $homeJSFolder = __DIR__ . "\\resources\\views\\pages\\home\\js";
        // Create the home.js file and write the extracted content
        $homeJSFile = $homeJSFolder . "\\home.js";
        if (file_put_contents($homeJSFile, "// JavaScript for home page")) {
            echo "home.js file created successfully inside the home/js folder.\n";
        } else {
            echo "Failed to create home.js file.\n";
        }

        // home css folder creation
        $homeFolder = __DIR__ . "\\resources\\views\\pages\\home\\css";
        echo "Creating Home css file file...\n";
        if (!is_dir($homeFolder)) {
            if (mkdir($homeFolder, 0777, true)) {
                echo "Home css file created successfully.\n";
            } else {
                echo "Failed to create Home css file.\n";
            }
        } else {
            echo "Home css file already exists.\n";
        }
        // home css folder path
        $homecssFolder = __DIR__ . "\\resources\\views\\pages\\home\\css";
        // Create the home.css file and write the extracted content
        $homecssFile = $homecssFolder . "\\home.css";
        if (file_put_contents($homecssFile, ' /* Styles for home page */ ')) {
            echo "home.css file created successfully inside the home/css folder.\n";
        } else {
            echo "Failed to create home.js file.\n";
        }



        // Add final configurations

        // HEADER
        $headerFile = __DIR__ . "\\resources\\views\\pages\\_header\\header.php";
        // The content to prepend
        $preContent = "<?php require __DIR__ . \"/../../../../app/models/LoadModel.php\"; ?>\n";
        // Check if the header.php file exists
        if (file_exists($headerFile)) {
            // Read the current content of the file
            $currentContent = file_get_contents($headerFile);

            // Prepend the new content to the existing content
            $newContent = $preContent . $currentContent;

            // Write the new content back to the file
            if (file_put_contents($headerFile, $newContent)) {
                echo "Successfully added the configuration at the beginning of header.php.\n";
            } else {
                echo "Failed to update header.php.\n";
            }
        } else {
            echo "The header.php file does not exist.\n";
        }
        // Check if the header.php file exists
        if (file_exists($headerFile)) {
            // Read the content of the header.php file
            $content = file_get_contents($headerFile);

            // Use regular expression to find all <link> tags and modify the href
            $content = preg_replace_callback('/<link[^>]*href="([^"]+)"/', function ($matches) {
                // The original href value
                $originalHref = $matches[1];

                // Modify the href by prepending the base URL
                $modifiedHref = '<?php echo EnvModel::env("APP_BASE_URL") ?>resources/views/' . $originalHref;

                // Replace the href in the <link> tag with the modified href
                return str_replace($originalHref, $modifiedHref, $matches[0]);
            }, $content);

            // Write the modified content back to the header.php file
            if (file_put_contents($headerFile, $content)) {
                echo "Successfully updated the href in <link> tags.\n";
            } else {
                echo "Failed to update the header.php file.\n";
            }
        } else {
            echo "The header.php file does not exist.\n";
        }

        // Check if the header.php file exists
        if (file_exists($headerFile)) {
            // Read the current content of the file
            $content = file_get_contents($headerFile);

            // Regular expression to find the <title> tag and replace its content
            $content = preg_replace('/<title[^>]*>.*<\/title>/i', '<title id="page_title"></title>', $content);

            // Write the modified content back to the file
            if (file_put_contents($headerFile, $content)) {
                echo "Successfully updated the title tag in header.php.\n";
            } else {
                echo "Failed to update the header.php file.\n";
            }
        } else {
            echo "The header.php file does not exist.\n";
        }

        // FOOTER
        $footerFile = __DIR__ . "\\resources\\views\\pages\\_footer\\footer.php";
        // The content to prepend
        $preContent = "<script>\n
                            // Page Title Definition \n
                            document.querySelector('#page_title').innerHTML = <?php echo json_encode(PagesTitleModel::getTitle()); ?>\n
                        </script>";
        // Check if the footer.php file exists
        if (file_exists($footerFile)) {
            // Read the current content of the file
            $currentContent = file_get_contents($footerFile);

            // Prepend the new content to the existing content
            $newContent = $preContent . $currentContent;

            // Write the new content back to the file
            if (file_put_contents($footerFile, $newContent)) {
                echo "Successfully added the configuration at the beginning of footer.php.\n";
            } else {
                echo "Failed to update footer.php.\n";
            }
        } else {
            echo "The footer.php file does not exist.\n";
        }
        // Check if the footer.php file exists
        if (file_exists($footerFile)) {
            // Read the content of the footer.php file
            $content = file_get_contents($footerFile);

            // Use regular expression to find all <link> tags and modify the href
            $content = preg_replace_callback('/<script[^>]*src="([^"]+)"/', function ($matches) {
                // The original href value
                $originalHref = $matches[1];

                // Modify the href by prepending the base URL
                $modifiedHref = '<?php echo EnvModel::env("APP_BASE_URL") ?>resources/views/' . $originalHref;

                // Replace the href in the <link> tag with the modified href
                return str_replace($originalHref, $modifiedHref, $matches[0]);
            }, $content);

            // Write the modified content back to the footer.php file
            if (file_put_contents($footerFile, $content)) {
                echo "Successfully updated the src in <script> tags.\n";
            } else {
                echo "Failed to update the footer.php file.\n";
            }
        } else {
            echo "The footer.php file does not exist.\n";
        }



        // HOMEPAGE
        $homeFile = __DIR__ . "\\resources\\views\\pages\\home\\home.php";
        // The content to prepend
        $preContent = "<?php include __DIR__ . '/../_header/header.php'; ?>\n
<!-- Page Title -->\n
<?php PagesTitleModel::title('Maxiter - Home Page'); ?>\n
<link rel='stylesheet' href='<?php echo EnvModel::env('APP_BASE_URL') ?>resources/views/pages/home/css/home.css'>\n";
        // Check if the home.php file exists
        if (file_exists($homeFile)) {
            // Read the current content of the file
            $currentContent = file_get_contents($homeFile);

            // Prepend the new content to the existing content
            $newContent = $preContent . $currentContent;

            // Write the new content back to the file
            if (file_put_contents($homeFile, $newContent)) {
                echo "Successfully added the configuration at the beginning of home.php.\n";
            } else {
                echo "Failed to update home.php.\n";
            }
        } else {
            echo "The home.php file does not exist.\n";
        }
        // The content to append
        $appendContent = "<script src='<?php echo EnvModel::env('APP_BASE_URL') ?>resources/views/pages/home/js/home.js'></script>\n
<?php include __DIR__ . '/../_footer/footer.php'; ?>";

        // Check if the home.php file exists
        if (file_exists($homeFile)) {
            // Read the current content of the file
            $currentContent = file_get_contents($homeFile);

            // Append the new content to the existing content
            $newContent = $currentContent . $appendContent;

            // Write the new content back to the file
            if (file_put_contents($homeFile, $newContent)) {
                echo "Successfully added the configuration at the end of home.php.\n";
            } else {
                echo "Failed to update home.php.\n";
            }
        } else {
            echo "The home.php file does not exist.\n";
        }

        // All SRC or URL IMAGE HOMEPAGE
        // Check if the home.php file exists
        if (file_exists($homeFile)) {
            // Read the current content of the file
            $content = file_get_contents($homeFile);

            // Regular expression to find and modify img src paths
            $content = preg_replace_callback('/<img[^>]*src=["\']([^"\']+)["\']/i', function ($matches) {
                $originalSrc = $matches[1];  // The original src value
                // Check if the path is relative (i.e., not starting with "http" or "//")
                if (strpos($originalSrc, 'http') === false && strpos($originalSrc, '//') === false) {
                    // Prepend the base URL and resources/views/ to the src path
                    $modifiedSrc = '<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalSrc;
                    return str_replace($originalSrc, $modifiedSrc, $matches[0]);
                }
                // If the src is already an absolute URL, return it unchanged
                return $matches[0];
            }, $content);

            // Regular expression to find and modify background-image url() paths
            $content = preg_replace_callback('/background-image:\s*url\(["\']?([^"\')]+)["\']?\)/i', function ($matches) {
                $originalUrl = $matches[1];  // The original URL in the background-image
                // Check if the path is relative
                if (strpos($originalUrl, 'http') === false && strpos($originalUrl, '//') === false) {
                    // Prepend the base URL and resources/views/ to the background-image URL
                    $modifiedUrl = 'url(<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalUrl . ')';
                    // Replace only the part inside the url() function with the modified URL
                    return preg_replace('/url\(["\']?([^"\')]+)["\']?\)/', $modifiedUrl, $matches[0]);
                }
                // If the URL is already absolute, return it unchanged
                return $matches[0];
            }, $content);

            // Regular expression to find and modify img src paths
            $content = preg_replace_callback('/<source[^>]*src=["\']([^"\']+)["\']/i', function ($matches) {
                $originalSrc = $matches[1];  // The original src value
                // Check if the path is relative (i.e., not starting with "http" or "//")
                if (strpos($originalSrc, 'http') === false && strpos($originalSrc, '//') === false) {
                    // Prepend the base URL and resources/views/ to the src path
                    $modifiedSrc = '<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalSrc;
                    return str_replace($originalSrc, $modifiedSrc, $matches[0]);
                }
                // If the src is already an absolute URL, return it unchanged
                return $matches[0];
            }, $content);

            // Write the modified content back to the file
            if (file_put_contents($homeFile, $content)) {
                echo "Successfully updated the src and background-image paths in home.php.\n";
            } else {
                echo "Failed to update the home.php file.\n";
            }
        } else {
            echo "The home.php file does not exist.\n";
        }

        // All SRC or URL IMAGE FOOTER
        $footerFile = __DIR__ . "\\resources\\views\\pages\\_footer\\footer.php";
        // Check if the footer.php file exists
        if (file_exists($footerFile)) {
            // Read the current content of the file
            $content = file_get_contents($footerFile);

            // Regular expression to find and modify img src paths
            $content = preg_replace_callback('/<img[^>]*src=["\']([^"\']+)["\']/i', function ($matches) {
                $originalSrc = $matches[1];  // The original src value
                // Check if the path is relative (i.e., not starting with "http" or "//")
                if (strpos($originalSrc, 'http') === false && strpos($originalSrc, '//') === false) {
                    // Prepend the base URL and resources/views/ to the src path
                    $modifiedSrc = '<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalSrc;
                    return str_replace($originalSrc, $modifiedSrc, $matches[0]);
                }
                // If the src is already an absolute URL, return it unchanged
                return $matches[0];
            }, $content);

            // Regular expression to find and modify background-image url() paths
            $content = preg_replace_callback('/background-image:\s*url\(["\']?([^"\')]+)["\']?\)/i', function ($matches) {
                $originalUrl = $matches[1];  // The original URL in the background-image
                // Check if the path is relative
                if (strpos($originalUrl, 'http') === false && strpos($originalUrl, '//') === false) {
                    // Prepend the base URL and resources/views/ to the background-image URL
                    $modifiedUrl = 'url(<?php echo EnvModel::env(\'APP_BASE_URL\') ?>resources/views/' . $originalUrl . ')';
                    // Replace only the part inside the url() function with the modified URL
                    return preg_replace('/url\(["\']?([^"\')]+)["\']?\)/', $modifiedUrl, $matches[0]);
                }
                // If the URL is already absolute, return it unchanged
                return $matches[0];
            }, $content);

            // Write the modified content back to the file
            if (file_put_contents($footerFile, $content)) {
                echo "Successfully updated the src and background-image paths in footer.php.\n";
            } else {
                echo "Failed to update the footer.php file.\n";
            }
        } else {
            echo "The footer.php file does not exist.\n";
        }
    }


    // Helper function to copy the contents of a subfolder (recursively)
    private function copyDirectoryContents($sourceDir, $destinationDir)
    {
        // Get the files and folders inside the source directory
        $items = scandir($sourceDir);

        // Iterate over the items in the subfolder
        foreach ($items as $item) {
            if ($item != '.' && $item != '..') {
                $sourcePath = $sourceDir . '\\' . $item;
                $destinationPath = $destinationDir . '\\' . $item;

                if (is_dir($sourcePath)) {
                    // If it's a directory, create it in the destination and copy its contents
                    if (!is_dir($destinationPath)) {
                        mkdir($destinationPath, 0777, true);
                    }
                    // Recursively copy the contents of the subfolder
                    $this->copyDirectoryContents($sourcePath, $destinationPath);
                } else {
                    // If it's a file, copy it
                    copy($sourcePath, $destinationPath);
                    echo "File '$item' copied successfully!\n";
                }
            }
        }
    }



    // ############################################################################ //
    // ############################################################################ //
    // ############################ SET NEW TEMPLATE ############################## //
    // ############################################################################ //
    // ############################################################################ //



    public function generateApiController($fileName)
    {
        $path = __DIR__ . '/app/controllers/' . $fileName . ".php";

        // Content to be written to the file
        $content = "<?php\n" .
            "/*\n" .
            "The API controller file handles user input and interaction. It processes requests,\n" .
            "invokes business logic, and returns as needed.\n" .
            "\n" .
            "@author Victor Béser\n" .
            "*/\n" .
            "class " . ucfirst($fileName) . " {\n\n" .
            "    public function main() {\n" .
            "        // Your code here\n" .
            "    }\n\n" .
            "}\n\n" .
            "\$controller = new " . ucfirst($fileName) . "();";

        // Create the /app directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app');
        // Create the /app/controllers directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app/controllers');

        // Check if the file already exists
        if (file_exists($path)) {
            echo "This controller already exists\n";
        } else {
            // Create the file and write the content
            file_put_contents($path, $content);
            echo "Controller $fileName created\n";
        }
    }

    public function generateMiddleware($fileName)
    {
        $path = __DIR__ . '/app/middlewares/' . $fileName . ".php";

        // Content to be written to the file
        $content = "<?php\n" .
            "/*\n" .
            "A middleware is a function that processes incoming requests \n" .
            "before they reach the main application or route handler.\n" .
            "It can modify requests, responses, or handle tasks like\n" .
            "authentication, logging, and error handling.\n" .
            "\n" .
            "@author Victor Béser\n" .
            "*/\n" .
            "require __DIR__ . '/../models/LoadModel.php';\n\n" .
            "class " . ucfirst($fileName) . " {\n\n" .
            "    public static function handle() {\n" .
            "        // Your code here\n" .
            "    }\n\n" .
            "}";

        // Create the /app directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app');
        // Create the /app/controllers directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/app/middlewares');

        // Check if the file already exists
        if (file_exists($path)) {
            echo "This middleware already exists\n";
        } else {
            // Create the file and write the content
            file_put_contents($path, $content);
            echo "Middleware $fileName created\n";
        }
    }

    public function generateUnitTest($fileName, $functionName)
    {
        $path = __DIR__ . '/tests/' . $fileName . "Test.php";

        // Content to be written to the file
        $content = "<?php\n" .
            "/*\n" .
            "This is an example of how to implement unit test into your application. \n" .
            "Feel free to try using PHP 8+ or PHP 5.3 legacy version below. \n" .
            "Checkout the /app/controllers/UnitTestController.php and /tests/UnitTestControllerTest.php \n" .
            "to see an example of how implement unit test in Maxiter!\n" .
            "\n" .
            "@author Victor Béser\n" .
            "*/\n" .
            "define('PHPUNIT_RUNNING', true);\n" .
            "use PHPUnit\Framework\TestCase;\n" .
            "require_once __DIR__ . '/../app/controllers/" . $fileName . ".php';\n\n" .
            "class " . ucfirst($fileName . "Test") . " extends TestCase {\n\n" .
            "    public function test" . ucfirst($functionName) . "() {\n" .
            "        // Your code here \n\n" .
            "    }\n\n" .
            "}";

        // Create the /tests directory if it doesn't exist
        $this->createDirectory(__DIR__ . '/tests');

        // Check if the file already exists
        if (file_exists($path)) {
            echo "This unit test already exists\n";
        } else {
            // Create the file and write the content
            file_put_contents($path, $content);
            echo "Unit test " . $fileName . "Test created in /tests/ for the controller in /app/controllers/$fileName.php\n";
            echo "Do not forget to use composer install command to install necessary dependencies for the Unit Test";
        }
    }

    public function PHPUnitTest()
    {


        $cmd = "php ./vendor/bin/phpunit";
        exec($cmd, $output, $returnCode);
        if ($returnCode === 0) {
            echo implode("\n", $output);
        } else {
            echo "Error: $returnCode";
        }
    }

    public function configProdEnv()
    {
        $gitignorePath = __DIR__ . '/.gitignore-example';

        $entries = array(
            'vendor/',
            'bash.php',
            'gui.html',
            'maxiter',
            'phpunit.xml',
            'README.md',
            'release_notes.txt',
        );

        $current = file_exists($gitignorePath) ? file($gitignorePath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES) : [];

        $merged = array_unique(array_merge($current, $entries));

        sort($merged);

        file_put_contents($gitignorePath, implode(PHP_EOL, $merged) . PHP_EOL);

        echo "Generated .gitignore-example with non-prod files\n";
    }

    public function configProdEnvDel()
    {
        $baseDir = dirname(__FILE__);

        $entries = array(
            'bash.php',
            'gui.html',
            'phpunit.xml',
            'README.md',
            'release_notes.txt',
            '.phpunit.result.cache',
            '.gitignore',
        );

        foreach ($entries as $entry) {
            $fullPath = $baseDir . '/' . $entry;

            if (is_dir($fullPath)) {
                $iterator = new RecursiveIteratorIterator(
                    new RecursiveDirectoryIterator($fullPath),
                    RecursiveIteratorIterator::CHILD_FIRST
                );

                foreach ($iterator as $item) {
                    $path = $item->getPathname();
                    if (in_array(basename($path), array('.', '..'))) {
                        continue;
                    }

                    if ($item->isFile()) {
                        if (@unlink($path)) {
                            echo "File deleted: $path\n";
                        }
                    }
                }

                echo "Files inside directory deleted: $entry\n";
            } elseif (is_file($fullPath)) {
                if (@unlink($fullPath)) {
                    echo "File deleted: $entry\n";
                }
            } else {
                echo "Not found: $entry\n";
            }
        }

        echo "All non-prod files successfully deleted (directories preserved).\n";
    }

    public function configProdEnvWithFolder()
    {
        $baseDir = dirname(__FILE__);
        $targetDir = $baseDir . '/_non-prod-files';

        if (!is_dir($targetDir)) {
            mkdir($targetDir, 0755, true);
            echo "Created directory: _non-prod-files\n";
        }

        $entries = array(
            'bash.php',
            'gui.html',
            'phpunit.xml',
            'README.md',
            'release_notes.txt',
            '.phpunit.result.cache',
            '.gitignore',
        );

        foreach ($entries as $entry) {
            $fullPath = $baseDir . '/' . $entry;

            if (is_dir($fullPath)) {
                $targetSubdir = $targetDir . '/' . basename($entry);

                $iterator = new RecursiveIteratorIterator(
                    new RecursiveDirectoryIterator($fullPath, RecursiveDirectoryIterator::SKIP_DOTS),
                    RecursiveIteratorIterator::SELF_FIRST
                );

                foreach ($iterator as $item) {
                    $subPath = $iterator->getSubPathName();
                    $targetPath = $targetSubdir . '/' . $subPath;

                    if ($item->isDir()) {
                        @mkdir($targetPath, 0755, true);
                    } else {
                        @copy($item, $targetPath);
                        @unlink($item);
                    }
                }

                echo "Directory moved: $entry\n";
                // Remove diretório original vazio
                @rmdir($fullPath);
            } elseif (is_file($fullPath)) {
                $targetPath = $targetDir . '/' . basename($entry);
                if (@rename($fullPath, $targetPath)) {
                    echo "File moved: $entry\n";
                } else {
                    echo "Failed to move file: $entry\n";
                }
            } else {
                echo "Not found: $entry\n";
            }
        }

        echo "All non-prod files moved to _non-prod-files.\n";
    }

    public function newComponent($componentName, $templateFolder = null)
    {


        $componentFolder = __DIR__ . "\\resources\\views\\pages\\_$componentName";
        echo "Creating _$componentName component...\n";
        if (!is_dir($componentFolder)) {
            if (mkdir($componentFolder, 0777, true)) {
                echo "_$componentName component created successfully in /resources/views/pages/_$componentName\n";
            } else {
                echo "Failed to create _$componentName component.\n";
            }
        } else {
            echo "_$componentName component already exists.\n";
        }

        if ($templateFolder == null) {

            // Create the header.php file and write the extracted content
            $componentFile = $componentFolder . "\\$componentName.php";
            $content = "<!--********** $componentName ***********-->\n<!-- Include this file in any file using the command below: -->\n<!-- " . '<?php include __DIR__ . "/../_' . $componentName . '/' . $componentName . '.php"; ?>' . " -->";
            if (file_put_contents($componentFile, $content)) {
                echo "$componentName.php file created successfully inside the _$componentName folder.\n";
            } else {
                echo "Failed to create $componentName.php file.\n";
            }
        } else {


            // Creating files and content
            // Path to the index.html template file
            $templateFolder = __DIR__ . "\\src\\template\\$templateFolder";  // Template source folder
            $indexFile = $templateFolder . "\\index.html";

            // _header folder path
            $headerFolder = __DIR__ . "\\resources\\views\\pages\\_$componentName";

            // Check if the index file exists
            if (file_exists($indexFile)) {
                // Read the content of index.html
                $fileContent = file_get_contents($indexFile);

                // Use regular expression to extract content between @header markers
                $pattern = '/@' . $componentName . '(.*?)@' . $componentName . '/s';
                if (preg_match($pattern, $fileContent, $matches)) {
                    // $matches[1] will contain the content between the @header markers

                    // Create the _header folder if it doesn't exist
                    if (!is_dir($headerFolder)) {
                        if (mkdir($headerFolder, 0777, true)) {
                            echo "_header folder created successfully.\n";
                        } else {
                            echo "Failed to create _header folder.\n";
                        }
                    }

                    // Create the header.php file and write the extracted content
                    $headerFile = $headerFolder . "\\$componentName.php";
                    if (file_put_contents($headerFile, $matches[1])) {
                        echo "$componentName.php file created successfully inside the _$componentName folder.\n";
                    } else {
                        echo "Failed to create $componentName.php file.\n";
                    }
                } else {
                    echo "No content found between @$componentName markers.\n";
                }
            } else {
                echo "The index.html file does not exist.\n";
            }
        }
    }

    public function mirrorExport($databaseName)
    {
        // Path to env.ini
        $envPath = __DIR__ . '/env.ini';

        // Validate env.ini existence
        if (!file_exists($envPath)) {
            echo "env.ini not found\n";
            return null;
        }

        // Parse env.ini with sections
        $env = parse_ini_file($envPath, true);
        if ($env === false || !is_array($env)) {
            echo "Failed to parse env.ini\n";
            return null;
        }

        // Determine the section: prefer direct section name, else match by DB value
        $sectionName = null;
        if (isset($env[$databaseName])) {
            $sectionName = $databaseName;
        } else {
            foreach ($env as $section => $values) {
                if (is_array($values) && isset($values['DB']) && strtolower($values['DB']) === strtolower($databaseName)) {
                    $sectionName = $section;
                    break;
                }
            }
        }

        if ($sectionName === null) {
            echo "Database '$databaseName' not found in env.ini\n";
            return null;
        }

        // Fetch connection data
        $driver = isset($env[$sectionName]['DRIVER']) ? $env[$sectionName]['DRIVER'] : null;
        $host   = isset($env[$sectionName]['HOST']) ? $env[$sectionName]['HOST'] : 'localhost';
        $port   = isset($env[$sectionName]['PORT']) ? $env[$sectionName]['PORT'] : '';
        $user   = isset($env[$sectionName]['USER']) ? $env[$sectionName]['USER'] : '';
        $pass   = isset($env[$sectionName]['PASS']) ? $env[$sectionName]['PASS'] : '';
        $dbName = isset($env[$sectionName]['DB']) ? $env[$sectionName]['DB'] : $sectionName;

        if ($driver === null || $driver === '') {
            echo "DRIVER not defined for database section [$sectionName]\n";
            return null;
        }

        // Normalize driver and set file extension
        $driverKey = strtolower(trim($driver));
        if (in_array($driverKey, ['mariadb'])) {
            $driverKey = 'mysql';
        }
        if (in_array($driverKey, ['psql', 'postgres', 'postgresql'])) {
            $driverKey = 'pgsql';
        }
        if (in_array($driverKey, ['sql server', 'sqlserver', 'mssql'])) {
            $driverKey = 'sqlsrv';
        }
        if (in_array($driverKey, ['oci', 'ora'])) {
            $driverKey = 'oracle';
        }

        $defaultExt = ($driverKey === 'sqlsrv') ? 'bak' : (($driverKey === 'oracle') ? 'dmp' : 'sql');
        $exportExt  = isset($env[$sectionName]['EXPORT_EXT']) && $env[$sectionName]['EXPORT_EXT'] !== '' ? trim($env[$sectionName]['EXPORT_EXT']) : $defaultExt;

        // Prepare mirror directory and target file: src/mirror/<dbName>/<dbName>-<timestamp>.<ext>
        $mirrorDir = __DIR__ . '/src/mirror';
        $this->createDirectory($mirrorDir);
        $dbDir    = $mirrorDir . '/' . $dbName;
        $this->createDirectory($dbDir);
        // Clean up existing exports from the same day before creating a new one
        $today = date('Ymd');
        try {
            $items = scandir($dbDir);
            foreach ($items as $it) {
                if ($it === '.' || $it === '..') continue;
                $full = $dbDir . '/' . $it;
                // Match full dump file for today: <db>-YYYYMMDD-HHMMSS.<ext>
                if (is_file($full)) {
                    if (preg_match('/^' . preg_quote($dbName, '/') . '-' . $today . '-\d{6}\.' . preg_quote($exportExt, '/') . '$/i', $it)) {
                        @unlink($full);
                    }
                }
                // Match per-table dir for today: tables-YYYYMMDD-HHMMSS
                if (is_dir($full)) {
                    if (preg_match('/^tables-' . $today . '-\d{6}$/i', $it)) {
                        $this->removeDirectory($full);
                    }
                }
            }
        } catch (Throwable $e) {
            echo "Warning: failed to cleanup same-day exports: " . $e->getMessage() . "\n";
        }

        $timestamp = date('Ymd-His');
        $fileName  = $dbName . '-' . $timestamp . '.' . $exportExt;
        $filePath  = $dbDir . '/' . $fileName;
        $tablesDir = $dbDir . '/tables-' . $timestamp;
        $this->createDirectory($tablesDir);

        // Environment flags used below
        $isWindows = strtoupper(substr(PHP_OS, 0, 3)) === 'WIN';

        // Optional command prefix (e.g., "docker exec -i <container>") for running dumps inside containers
        $execPrefix = isset($env[$sectionName]['EXEC_PREFIX']) ? trim($env[$sectionName]['EXEC_PREFIX']) : '';
        $isDockerExec = $execPrefix !== '' && (stripos($execPrefix, 'docker exec') !== false || stripos($execPrefix, 'docker-compose exec') !== false);

        // Try to list tables using PDO (for per-table dumps)
        $tables = [];
        try {
            if ($driverKey === 'mysql') {
                $dsn = 'mysql:host=' . $host . ';' . ($port !== '' ? 'port=' . $port . ';' : '') . 'dbname=' . $dbName . ';charset=utf8mb4';
            } else if ($driverKey === 'pgsql' || $driverKey === 'postgres' || $driverKey === 'postgresql') {
                $dsn = 'pgsql:host=' . $host . ';' . ($port !== '' ? 'port=' . $port . ';' : '') . 'dbname=' . $dbName;
            } else {
                $dsn = '';
            }
            if ($dsn !== '') {
                $pdo = new PDO($dsn, $user, $pass, [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);
                if ($driverKey === 'mysql') {
                    $stmt = $pdo->query('SHOW TABLES');
                    while ($row = $stmt->fetch(PDO::FETCH_NUM)) {
                        if (!empty($row[0])) $tables[] = $row[0];
                    }
                } else {
                    $stmt = $pdo->query("SELECT tablename FROM pg_catalog.pg_tables WHERE schemaname = 'public'");
                    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
                        if (!empty($row['tablename'])) $tables[] = $row['tablename'];
                    }
                }
            }
        } catch (Throwable $e) {
            echo "Warning: failed to list tables via PDO: " . $e->getMessage() . "\n";
        }



        if ($driverKey === 'mysql') {
            // Resolve mysqldump binary: allow override via env.ini, then Windows XAMPP path, else PATH
            $mysqldump = isset($env[$sectionName]['MYSQLDUMP_PATH']) && $env[$sectionName]['MYSQLDUMP_PATH'] !== '' ? $env[$sectionName]['MYSQLDUMP_PATH'] : 'mysqldump';
            if ($isWindows && $mysqldump === 'mysqldump') {
                $defaultWinPath = 'C:\\xampp\\mysql\\bin\\mysqldump.exe';
                if (file_exists($defaultWinPath)) {
                    $mysqldump = $defaultWinPath;
                }
            }

            // Use --result-file to avoid redirecting errors into the dump file (Windows-friendly)
            echo "Exporting database '$dbName' to '$filePath'...\n";
            $this->flushOutput();
            $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $mysqldump . '"'
                . ' --host="' . $host . '"'
                . ($port !== '' ? ' --port="' . $port . '"' : '')
                . ' --user="' . $user . '"'
                . ' --password="' . $pass . '"'
                . ' --routines --events --triggers --single-transaction --add-drop-table'
                . ' --result-file="' . $filePath . '"'
                . ' "' . $dbName . '"';

            shell_exec($cmd);

            if (file_exists($filePath) && filesize($filePath) > 0) {
                echo "Exported: $filePath (" . round(filesize($filePath) / 1024, 1) . " KB)\n";
                // Export each table individually
                $count = 0;
                foreach ($tables as $table) {
                    echo "  -> Exporting table '$table'...";
                    $this->flushOutput();
                    $tableFile = $tablesDir . '/' . $table . '.sql';
                    $tcmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $mysqldump . '"'
                        . ' --host="' . $host . '"'
                        . ($port !== '' ? ' --port="' . $port . '"' : '')
                        . ' --user="' . $user . '"'
                        . ' --password="' . $pass . '"'
                        . ' --triggers --single-transaction --add-drop-table'
                        . ' --result-file="' . $tableFile . '"'
                        . ' "' . $dbName . '" "' . $table . '"';

                    shell_exec($tcmd);
                    if (file_exists($tableFile) && filesize($tableFile) > 0) {
                        echo " OK (" . round(filesize($tableFile) / 1024, 1) . " KB)\n";
                        $count++;
                    } else {
                        echo " FAILED\n";
                    }
                }
                if (!empty($tables)) {
                    echo "Exported tables: $count to $tablesDir\n";
                }
                return $filePath;
            } else {
                echo "Failed to export MySQL database. Ensure mysqldump is installed and credentials are correct.\n";
                return null;
            }
        } else if ($driverKey === 'pgsql') {
            // Resolve pg_dump binary: allow override via env.ini, else PATH
            $pgDump = isset($env[$sectionName]['PG_DUMP_PATH']) && $env[$sectionName]['PG_DUMP_PATH'] !== '' ? $env[$sectionName]['PG_DUMP_PATH'] : 'pg_dump';

            if ($isWindows) {
                echo "Exporting database '$dbName' to '$filePath'...\n";
                $this->flushOutput();
                if ($isDockerExec) {
                    // Pass PGPASSWORD to the container environment
                    $cmd = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $pgDump . '"'
                        . ' --host="' . $host . '"'
                        . ($port !== '' ? ' --port="' . $port . '"' : '')
                        . ' --username="' . $user . '"'
                        . ' --format=p --no-owner'
                        . ' --file="' . $filePath . '"'
                        . ' "' . $dbName . '" 2>&1';
                } else {
                    $cmd = 'set "PGPASSWORD=' . $pass . '" && ' . '"' . $pgDump . '"'
                        . ' --host="' . $host . '"'
                        . ($port !== '' ? ' --port="' . $port . '"' : '')
                        . ' --username="' . $user . '"'
                        . ' --format=p --no-owner'
                        . ' --file="' . $filePath . '"'
                        . ' "' . $dbName . '" 2>&1';
                }
            } else {
                echo "Exporting database '$dbName' to '$filePath'...\n";
                $this->flushOutput();
                if ($isDockerExec) {
                    // Pass PGPASSWORD to the container environment
                    $cmd = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $pgDump . '"'
                        . ' --host="' . $host . '"'
                        . ($port !== '' ? ' --port="' . $port . '"' : '')
                        . ' --username="' . $user . '"'
                        . ' --format=p --no-owner'
                        . ' --file="' . $filePath . '"'
                        . ' "' . $dbName . '" 2>&1';
                } else {
                    $cmd = 'PGPASSWORD="' . $pass . '" ' . '"' . $pgDump . '"'
                        . ' --host="' . $host . '"'
                        . ($port !== '' ? ' --port="' . $port . '"' : '')
                        . ' --username="' . $user . '"'
                        . ' --format=p --no-owner'
                        . ' --file="' . $filePath . '"'
                        . ' "' . $dbName . '" 2>&1';
                }
            }

            shell_exec($cmd);

            if (file_exists($filePath) && filesize($filePath) > 0) {
                echo "Exported: $filePath (" . round(filesize($filePath) / 1024, 1) . " KB)\n";
                // Export each table individually
                $count = 0;
                foreach ($tables as $table) {
                    echo "  -> Exporting table '$table'...";
                    $this->flushOutput();
                    $tableFile = $tablesDir . '/' . $table . '.sql';
                    if ($isWindows) {
                        if ($isDockerExec) {
                            $tc = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $pgDump . '"'
                                . ' --host="' . $host . '"'
                                . ($port !== '' ? ' --port="' . $port . '"' : '')
                                . ' --username="' . $user . '"'
                                . ' --format=p --no-owner'
                                . ' -t public."' . $table . '"'
                                . ' --file="' . $tableFile . '"'
                                . ' "' . $dbName . '"';
                        } else {
                            $tc = 'set "PGPASSWORD=' . $pass . '" && ' . '"' . $pgDump . '"'
                                . ' --host="' . $host . '"'
                                . ($port !== '' ? ' --port="' . $port . '"' : '')
                                . ' --username="' . $user . '"'
                                . ' --format=p --no-owner'
                                . ' -t public."' . $table . '"'
                                . ' --file="' . $tableFile . '"'
                                . ' "' . $dbName . '"';
                        }
                    } else {
                        if ($isDockerExec) {
                            $tc = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $pgDump . '"'
                                . ' --host="' . $host . '"'
                                . ($port !== '' ? ' --port="' . $port . '"' : '')
                                . ' --username="' . $user . '"'
                                . ' --format=p --no-owner'
                                . ' -t public."' . $table . '"'
                                . ' --file="' . $tableFile . '"'
                                . ' "' . $dbName . '"';
                        } else {
                            $tc = 'PGPASSWORD="' . $pass . '" ' . '"' . $pgDump . '"'
                                . ' --host="' . $host . '"'
                                . ($port !== '' ? ' --port="' . $port . '"' : '')
                                . ' --username="' . $user . '"'
                                . ' --format=p --no-owner'
                                . ' -t public."' . $table . '"'
                                . ' --file="' . $tableFile . '"'
                                . ' "' . $dbName . '"';
                        }
                    }

                    shell_exec($tc);
                    if (file_exists($tableFile) && filesize($tableFile) > 0) {
                        echo " OK (" . round(filesize($tableFile) / 1024, 1) . " KB)\n";
                        $count++;
                    } else {
                        echo " FAILED\n";
                    }
                }
                if (!empty($tables)) {
                    echo "Exported tables: $count to $tablesDir\n";
                }
                return $filePath;
            } else {
                echo "Failed to export PostgreSQL database. Ensure pg_dump is installed and credentials are correct.\n";
                return null;
            }
        } else if ($driverKey === 'sqlsrv') {
            // SQL Server: generate a full database backup (.bak) using sqlcmd
            $sqlcmd = isset($env[$sectionName]['SQLCMD_PATH']) && $env[$sectionName]['SQLCMD_PATH'] !== '' ? $env[$sectionName]['SQLCMD_PATH'] : 'sqlcmd';
            $server = $host . ($port !== '' ? ',' . $port : '');

            echo "Exporting SQL Server database '$dbName' to '$filePath'...\n";
            $this->flushOutput();

            // Allow custom command override if provided
            $customCmd = isset($env[$sectionName]['CUSTOM_EXPORT_CMD']) ? trim($env[$sectionName]['CUSTOM_EXPORT_CMD']) : '';
            if ($customCmd !== '') {
                $replacements = [
                    '%HOST%' => $host,
                    '%PORT%' => $port,
                    '%USER%' => $user,
                    '%PASS%' => $pass,
                    '%DB%'   => $dbName,
                    '%FILE%' => $filePath,
                ];
                $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . strtr($customCmd, $replacements);
            } else {
                $backupQuery = "BACKUP DATABASE [" . $dbName . "] TO DISK = N'" . $filePath . "' WITH INIT, COPY_ONLY";
                $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $sqlcmd . '"'
                    . ' -S "' . $server . '"'
                    . ' -U "' . $user . '" -P "' . $pass . '"'
                    . ' -Q "' . $backupQuery . '" -b';
            }

            shell_exec($cmd);
            if (file_exists($filePath) && filesize($filePath) > 0) {
                echo "Exported: $filePath (" . round(filesize($filePath) / 1024, 1) . " KB)\n";
                // Per-table SQL scripts are not supported via sqlcmd by default
                echo "Note: per-table .sql exports are not available for SQL Server.\n";
                return $filePath;
            } else {
                echo "Failed to export SQL Server database. Ensure sqlcmd is installed, credentials are correct, and the path is writable.\n";
                return null;
            }
        } else if ($driverKey === 'oracle') {
            // Oracle: require a custom export command due to tooling variability (expdp/sqlplus)
            echo "Exporting Oracle database '$dbName' to '$filePath'...\n";
            $this->flushOutput();

            $customCmd = isset($env[$sectionName]['CUSTOM_EXPORT_CMD']) ? trim($env[$sectionName]['CUSTOM_EXPORT_CMD']) : '';
            if ($customCmd === '') {
                echo "Oracle export requires CUSTOM_EXPORT_CMD in env.ini (templated with %HOST%, %PORT%, %USER%, %PASS%, %DB%, %FILE%).\n";
                echo "Example: expdp %USER%/%PASS%@%HOST%:%PORT%/%DB% full=y dumpfile=%FILE%\n";
                return null;
            }

            $replacements = [
                '%HOST%' => $host,
                '%PORT%' => ($port !== '' ? $port : '1521'),
                '%USER%' => $user,
                '%PASS%' => $pass,
                '%DB%'   => $dbName,
                '%FILE%' => $filePath,
            ];
            $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . strtr($customCmd, $replacements);
            shell_exec($cmd);
            if (file_exists($filePath) && filesize($filePath) > 0) {
                echo "Exported: $filePath (" . round(filesize($filePath) / 1024, 1) . " KB)\n";
                echo "Note: Oracle per-table .sql exports are not available by default in this mode.\n";
                return $filePath;
            } else {
                echo "Failed to export Oracle database. Check CUSTOM_EXPORT_CMD tooling and ensure the target path is mounted/writable.\n";
                return null;
            }
        } else {
            echo "Unsupported driver '$driver' for export. Supported: mysql/mariadb, pgsql/psql, sql server (sqlcmd), oracle (custom).\n";
            return null;
        }
    }

    public function mirrorImport($databaseName, $date = null)
    {
        // Path to env.ini
        $envPath = __DIR__ . '/env.ini';

        // Validate env.ini existence
        if (!file_exists($envPath)) {
            echo "env.ini not found\n";
            return null;
        }

        // Parse env.ini with sections
        $env = parse_ini_file($envPath, true);
        if ($env === false || !is_array($env)) {
            echo "Failed to parse env.ini\n";
            return null;
        }

        // Determine the section: prefer direct section name, else match by DB value
        $sectionName = null;
        if (isset($env[$databaseName])) {
            $sectionName = $databaseName;
        } else {
            foreach ($env as $section => $values) {
                if (is_array($values) && isset($values['DB']) && strtolower($values['DB']) === strtolower($databaseName)) {
                    $sectionName = $section;
                    break;
                }
            }
        }

        if ($sectionName === null) {
            echo "Database '$databaseName' not found in env.ini\n";
            return null;
        }

        // Fetch connection data
        $driver = isset($env[$sectionName]['DRIVER']) ? $env[$sectionName]['DRIVER'] : null;
        $host   = isset($env[$sectionName]['HOST']) ? $env[$sectionName]['HOST'] : 'localhost';
        $port   = isset($env[$sectionName]['PORT']) ? $env[$sectionName]['PORT'] : '';
        $user   = isset($env[$sectionName]['USER']) ? $env[$sectionName]['USER'] : '';
        $pass   = isset($env[$sectionName]['PASS']) ? $env[$sectionName]['PASS'] : '';
        $dbName = isset($env[$sectionName]['DB']) ? $env[$sectionName]['DB'] : $sectionName;

        if ($driver === null || $driver === '') {
            echo "DRIVER not defined for database section [$sectionName]\n";
            return null;
        }

        // Normalize driver and determine file extension
        $driverKey = strtolower(trim($driver));
        if (in_array($driverKey, ['mariadb'])) {
            $driverKey = 'mysql';
        }
        if (in_array($driverKey, ['psql', 'postgres', 'postgresql'])) {
            $driverKey = 'pgsql';
        }
        if (in_array($driverKey, ['sql server', 'sqlserver', 'mssql'])) {
            $driverKey = 'sqlsrv';
        }
        if (in_array($driverKey, ['oci', 'ora'])) {
            $driverKey = 'oracle';
        }

        $defaultExt = ($driverKey === 'sqlsrv') ? 'bak' : (($driverKey === 'oracle') ? 'dmp' : 'sql');
        $importExt  = isset($env[$sectionName]['EXPORT_EXT']) && $env[$sectionName]['EXPORT_EXT'] !== '' ? trim($env[$sectionName]['EXPORT_EXT']) : $defaultExt;

        // Prepare mirror directory: src/mirror/<dbName>
        $mirrorDir = __DIR__ . '/src/mirror';
        $dbDir     = $mirrorDir . '/' . $dbName;
        if (!is_dir($dbDir)) {
            echo "Import directory not found: $dbDir\n";
            return null;
        }

        // Environment flags and optional exec prefix (e.g., docker exec)
        $isWindows  = strtoupper(substr(PHP_OS, 0, 3)) === 'WIN';
        $execPrefix = isset($env[$sectionName]['EXEC_PREFIX']) ? trim($env[$sectionName]['EXEC_PREFIX']) : '';
        $isDockerExec = $execPrefix !== '' && (stripos($execPrefix, 'docker exec') !== false || stripos($execPrefix, 'docker-compose exec') !== false);

        // Optional date filter (expected format dd-mm-yyyy). If provided, only full dump is considered.
        $targetYmd = null; // YYYYMMDD
        if ($date !== null && trim($date) !== '') {
            $dateNorm = str_replace(['/', '.', ' '], ['-', '-', '-'], trim($date));
            if (preg_match('/^(\d{2})-(\d{2})-(\d{4})$/', $dateNorm, $m)) {
                // Build YYYYMMDD from dd-mm-yyyy
                $targetYmd = $m[3] . $m[2] . $m[1];
                echo "Filtering by date: " . $m[1] . '-' . $m[2] . '-' . $m[3] . "\n";
                $this->flushOutput();
            } else {
                echo "Invalid date format '$date' (expected dd-mm-yyyy). Using latest.\n";
                $this->flushOutput();
            }
        }

        // Locate full dump file by name timestamp; prefer latest or match specific date
        $pattern = $dbDir . '/' . $dbName . '-*.' . $importExt;
        $selectedFile = null;
        $bestStamp = -1; // numeric YYYYMMDDHHMMSS
        $files = glob($pattern);
        if (is_array($files)) {
            foreach ($files as $f) {
                if (!is_file($f)) {
                    continue;
                }
                $base = basename($f);
                // Match -YYYYMMDD-HHMMSS before extension
                $extEsc = preg_quote($importExt, '/');
                if (preg_match('/-([0-9]{8})-([0-9]{6})\.' . $extEsc . '$/i', $base, $m)) {
                    $ymd = $m[1];
                    $his = $m[2];
                    if ($targetYmd !== null && $ymd !== $targetYmd) {
                        continue;
                    }
                    $stamp = (int)($ymd . $his);
                    if ($stamp > $bestStamp) {
                        $bestStamp = $stamp;
                        $selectedFile = $f;
                    }
                }
            }
        }

        // If no full dump selected and no date filter, locate latest per-table directory
        $latestTablesDir = null;
        if ($selectedFile === null && $targetYmd === null) {
            $candidateDirs = glob($dbDir . '/tables-*');
            if (is_array($candidateDirs)) {
                $bestDirStamp = -1;
                foreach ($candidateDirs as $d) {
                    if (!is_dir($d)) {
                        continue;
                    }
                    $base = basename($d);
                    if (preg_match('/tables-([0-9]{8})-([0-9]{6})$/', $base, $m)) {
                        $stamp = (int)($m[1] . $m[2]);
                        if ($stamp > $bestDirStamp) {
                            $bestDirStamp = $stamp;
                            $latestTablesDir = $d;
                        }
                    }
                }
            }
        }

        if ($selectedFile !== null) {
            echo "Importing database '$dbName' from '$selectedFile'...\n";
            $this->flushOutput();

            if ($driverKey === 'mysql') {
                // Resolve mysql client binary
                $mysql = isset($env[$sectionName]['MYSQL_PATH']) && $env[$sectionName]['MYSQL_PATH'] !== '' ? $env[$sectionName]['MYSQL_PATH'] : 'mysql';
                if ($isWindows && $mysql === 'mysql') {
                    $defaultWinPath = 'C:\\xampp\\mysql\\bin\\mysql.exe';
                    if (file_exists($defaultWinPath)) {
                        $mysql = $defaultWinPath;
                    }
                }

                // Overwrite: drop and recreate database to import cleanly
                $dropCreateCmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $mysql . '"'
                    . ' --host="' . $host . '"'
                    . ($port !== '' ? ' --port="' . $port . '"' : '')
                    . ' --user="' . $user . '"'
                    . ' --password="' . $pass . '"'
                    . ' -e "DROP DATABASE IF EXISTS `' . $dbName . '`; CREATE DATABASE `' . $dbName . '` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"';
                $dropCreateStatus = 0;
                $dropCreateOutput = [];
                @exec($dropCreateCmd, $dropCreateOutput, $dropCreateStatus);
                if ($dropCreateStatus !== 0) {
                    echo "Warning: failed to drop/recreate database '$dbName' (exit $dropCreateStatus). Proceeding with import.\n";
                }

                // Use client-side source to import the file (works on Windows and avoids redirection issues)
                // Normalize Windows path separators for mysql 'source' command
                $selectedFileForMysql = str_replace('\\', '/', $selectedFile);
                $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $mysql . '"'
                    . ' --host="' . $host . '"'
                    . ($port !== '' ? ' --port="' . $port . '"' : '')
                    . ' --user="' . $user . '"'
                    . ' --password="' . $pass . '"'
                    . ' "' . $dbName . '"'
                    . ' -e "SET FOREIGN_KEY_CHECKS=0; source ' . $selectedFileForMysql . '; SET FOREIGN_KEY_CHECKS=1;"';
                $importStatus = 0;
                $importOutput = [];
                @exec($cmd, $importOutput, $importStatus);
                if ($importStatus === 0) {
                    echo "Imported: $selectedFile\n";
                    return $selectedFile;
                } else {
                    echo "Import failed for '$selectedFile' (exit $importStatus).\n";
                    return null;
                }
            } else if ($driverKey === 'pgsql') {
                // Resolve psql binary
                $psql = isset($env[$sectionName]['PSQL_PATH']) && $env[$sectionName]['PSQL_PATH'] !== '' ? $env[$sectionName]['PSQL_PATH'] : 'psql';

                if ($isWindows) {
                    if ($isDockerExec) {
                        $cmd = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $psql . '"'
                            . ' -h "' . $host . '"'
                            . ($port !== '' ? ' -p "' . $port . '"' : '')
                            . ' -U "' . $user . '"'
                            . ' -d "' . $dbName . '"'
                            . ' -v ON_ERROR_STOP=1'
                            . ' -f "' . $selectedFile . '"';
                    } else {
                        $cmd = 'set "PGPASSWORD=' . $pass . '" && ' . '"' . $psql . '"'
                            . ' -h "' . $host . '"'
                            . ($port !== '' ? ' -p "' . $port . '"' : '')
                            . ' -U "' . $user . '"'
                            . ' -d "' . $dbName . '"'
                            . ' -v ON_ERROR_STOP=1'
                            . ' -f "' . $selectedFile . '"';
                    }
                } else {
                    if ($isDockerExec) {
                        $cmd = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $psql . '"'
                            . ' -h "' . $host . '"'
                            . ($port !== '' ? ' -p "' . $port . '"' : '')
                            . ' -U "' . $user . '"'
                            . ' -d "' . $dbName . '"'
                            . ' -v ON_ERROR_STOP=1'
                            . ' -f "' . $selectedFile . '"';
                    } else {
                        $cmd = 'PGPASSWORD="' . $pass . '" ' . '"' . $psql . '"'
                            . ' -h "' . $host . '"'
                            . ($port !== '' ? ' -p "' . $port . '"' : '')
                            . ' -U "' . $user . '"'
                            . ' -d "' . $dbName . '"'
                            . ' -v ON_ERROR_STOP=1'
                            . ' -f "' . $selectedFile . '"';
                    }
                }

                shell_exec($cmd);
                echo "Imported: $selectedFile\n";
                return $selectedFile;
            } else if ($driverKey === 'sqlsrv') {
                // SQL Server restore from .bak
                $sqlcmd = isset($env[$sectionName]['SQLCMD_PATH']) && $env[$sectionName]['SQLCMD_PATH'] !== '' ? $env[$sectionName]['SQLCMD_PATH'] : 'sqlcmd';
                $server  = $host . ($port !== '' ? ',' . $port : '');
                $serverFile = isset($env[$sectionName]['SERVER_FILE_PATH']) && $env[$sectionName]['SERVER_FILE_PATH'] !== '' ? $env[$sectionName]['SERVER_FILE_PATH'] : $selectedFile;

                echo "Note: SQL Server requires the .bak to be readable by the server service.\n";
                $restoreQuery = "RESTORE DATABASE [" . $dbName . "] FROM DISK = N'" . $serverFile . "' WITH REPLACE";
                $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $sqlcmd . '"'
                    . ' -S "' . $server . '" -U "' . $user . '" -P "' . $pass . '"'
                    . ' -Q "' . $restoreQuery . '" -b';

                shell_exec($cmd);
                echo "Restore command executed. Check SQL Server for completion.\n";
                return $selectedFile;
            } else if ($driverKey === 'oracle') {
                // Oracle import requires a custom command (impdp/sqlplus) with directory objects set up
                $customCmd = isset($env[$sectionName]['CUSTOM_IMPORT_CMD']) ? trim($env[$sectionName]['CUSTOM_IMPORT_CMD']) : '';
                if ($customCmd === '') {
                    echo "Oracle import requires CUSTOM_IMPORT_CMD in env.ini (templated with %HOST%, %PORT%, %USER%, %PASS%, %DB%, %FILE%).\n";
                    echo "Example: impdp %USER%/%PASS%@%HOST%:%PORT%/%DB% full=y dumpfile=%FILE%\n";
                    return null;
                }
                $replacements = [
                    '%HOST%' => $host,
                    '%PORT%' => ($port !== '' ? $port : '1521'),
                    '%USER%' => $user,
                    '%PASS%' => $pass,
                    '%DB%'   => $dbName,
                    '%FILE%' => $selectedFile,
                ];
                $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . strtr($customCmd, $replacements);
                shell_exec($cmd);
                echo "Import command executed for Oracle.\n";
                return $selectedFile;
            } else {
                echo "Unsupported driver '$driver' for import.\n";
                return null;
            }
        } else if ($latestTablesDir !== null) {
            echo "No full dump found. Importing per-table from '$latestTablesDir'...\n";
            $this->flushOutput();

            // Gather table files
            $tableFiles = [];
            $items = scandir($latestTablesDir);
            foreach ($items as $it) {
                if ($it !== '.' && $it !== '..' && substr($it, -4) === '.sql') {
                    $tableFiles[] = $latestTablesDir . '/' . $it;
                }
            }

            if ($driverKey === 'mysql') {
                $mysql = isset($env[$sectionName]['MYSQL_PATH']) && $env[$sectionName]['MYSQL_PATH'] !== '' ? $env[$sectionName]['MYSQL_PATH'] : 'mysql';
                if ($isWindows && $mysql === 'mysql') {
                    $defaultWinPath = 'C:\\xampp\\mysql\\bin\\mysql.exe';
                    if (file_exists($defaultWinPath)) {
                        $mysql = $defaultWinPath;
                    }
                }
                // Overwrite: drop and recreate database before per-table import
                $dropCreateCmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $mysql . '"'
                    . ' --host="' . $host . '"'
                    . ($port !== '' ? ' --port="' . $port . '"' : '')
                    . ' --user="' . $user . '"'
                    . ' --password="' . $pass . '"'
                    . ' -e "DROP DATABASE IF EXISTS `' . $dbName . '`; CREATE DATABASE `' . $dbName . '` CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"';
                @shell_exec($dropCreateCmd);
                $count = 0;
                foreach ($tableFiles as $tf) {
                    $tableName = basename($tf, '.sql');
                    echo "  -> Importing table '$tableName'...";
                    $this->flushOutput();
                    $tfForMysql = str_replace('\\', '/', $tf);
                    $cmd = ($execPrefix !== '' ? $execPrefix . ' ' : '') . '"' . $mysql . '"'
                        . ' --host="' . $host . '"'
                        . ($port !== '' ? ' --port="' . $port . '"' : '')
                        . ' --user="' . $user . '"'
                        . ' --password="' . $pass . '"'
                        . ' "' . $dbName . '"'
                        . ' -e "SET FOREIGN_KEY_CHECKS=0; source ' . $tfForMysql . '; SET FOREIGN_KEY_CHECKS=1;"';
                    $tableStatus = 0;
                    $tableOutput = [];
                    @exec($cmd, $tableOutput, $tableStatus);
                    if ($tableStatus === 0) {
                        echo " OK\n";
                        $count++;
                    } else {
                        echo " FAILED (exit $tableStatus)\n";
                    }
                }
                echo "Imported $count tables from $latestTablesDir\n";
                return $latestTablesDir;
            } else if ($driverKey === 'pgsql') {
                $psql = isset($env[$sectionName]['PSQL_PATH']) && $env[$sectionName]['PSQL_PATH'] !== '' ? $env[$sectionName]['PSQL_PATH'] : 'psql';
                $count = 0;
                foreach ($tableFiles as $tf) {
                    $tableName = basename($tf, '.sql');
                    echo "  -> Importing table '$tableName'...";
                    $this->flushOutput();
                    if ($isWindows) {
                        if ($isDockerExec) {
                            $tc = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $psql . '"'
                                . ' -h "' . $host . '"'
                                . ($port !== '' ? ' -p "' . $port . '"' : '')
                                . ' -U "' . $user . '"'
                                . ' -d "' . $dbName . '"'
                                . ' -v ON_ERROR_STOP=1'
                                . ' -f "' . $tf . '"';
                        } else {
                            $tc = 'set "PGPASSWORD=' . $pass . '" && ' . '"' . $psql . '"'
                                . ' -h "' . $host . '"'
                                . ($port !== '' ? ' -p "' . $port . '"' : '')
                                . ' -U "' . $user . '"'
                                . ' -d "' . $dbName . '"'
                                . ' -v ON_ERROR_STOP=1'
                                . ' -f "' . $tf . '"';
                        }
                    } else {
                        if ($isDockerExec) {
                            $tc = $execPrefix . ' -e PGPASSWORD="' . $pass . '" ' . '"' . $psql . '"'
                                . ' -h "' . $host . '"'
                                . ($port !== '' ? ' -p "' . $port . '"' : '')
                                . ' -U "' . $user . '"'
                                . ' -d "' . $dbName . '"'
                                . ' -v ON_ERROR_STOP=1'
                                . ' -f "' . $tf . '"';
                        } else {
                            $tc = 'PGPASSWORD="' . $pass . '" ' . '"' . $psql . '"'
                                . ' -h "' . $host . '"'
                                . ($port !== '' ? ' -p "' . $port . '"' : '')
                                . ' -U "' . $user . '"'
                                . ' -d "' . $dbName . '"'
                                . ' -v ON_ERROR_STOP=1'
                                . ' -f "' . $tf . '"';
                        }
                    }
                    shell_exec($tc);
                    echo " OK\n";
                    $count++;
                }
                echo "Imported $count tables from $latestTablesDir\n";
                return $latestTablesDir;
            } else {
                echo "Per-table import not supported for driver '$driver'.\n";
                return null;
            }
        } else {
            if ($targetYmd !== null) {
                echo "No full dump found for date '$date' in $dbDir\n";
            } else {
                echo "No dump file or per-table directory found in $dbDir\n";
            }
            return null;
        }
    }

    private function flushOutput()
    {
        if (function_exists('ob_get_level') && ob_get_level() > 0) {
            @ob_flush();
        }
        @flush();
        if (defined('STDOUT')) {
            @fflush(STDOUT);
        }
        if (defined('STDERR')) {
            @fflush(STDERR);
        }
    }

    private function createDirectory($dir)
    {
        if (!file_exists($dir)) {
            mkdir($dir, 0777, true);
        }
    }

    private function removeDirectory($dir)
    {
        if (!is_dir($dir)) return;
        $items = scandir($dir);
        foreach ($items as $it) {
            if ($it === '.' || $it === '..') continue;
            $full = $dir . '/' . $it;
            if (is_dir($full)) {
                $this->removeDirectory($full);
            } else {
                @unlink($full);
            }
        }
        @rmdir($dir);
    }

    public function selfUpdate()
    {
        echo "🔍 Checking for updates...\n";

        $env = parse_ini_file(__DIR__ . "/env.ini", true);
        $user = isset($env['app']['UPDATE_USER']) ? $env['app']['UPDATE_USER'] : 'maxiter-php';
        $repo = isset($env['app']['UPDATE_REPO']) ? $env['app']['UPDATE_REPO'] : 'maxiter';
        $branch = isset($env['app']['UPDATE_BRANCH']) ? $env['app']['UPDATE_BRANCH'] : 'main';

        $localVersionFile = __DIR__ . "/version.json";
        $remoteVersionUrl = "https://raw.githubusercontent.com/$user/$repo/$branch/version.json";

        if (!file_exists($localVersionFile)) {
            echo "❌ Local version not found.\n";
            return;
        }

        $local = json_decode(file_get_contents($localVersionFile), true);
        $remote = json_decode(file_get_contents($remoteVersionUrl), true);

        if (!$remote) {
            echo "❌ Could not check remote version.\n";
            return;
        }

        if ($remote['version'] == $local['version']) {
            echo "✔ Maxiter is already up to date (v{$local['version']}).\n";
            return;
        }

        echo "📥 New version found: {$remote['version']} (current {$local['version']})\n";

        $zipUrl = "https://github.com/$user/$repo/archive/refs/heads/$branch.zip";
        $zipFile = __DIR__ . "/maxiter_update.zip";

        file_put_contents($zipFile, file_get_contents($zipUrl));

        echo "📦 Downloaded update package.\n";

        $extractPath = __DIR__ . "/update_temp";
        mkdir($extractPath);

        $zip = new ZipArchive();
        if ($zip->open($zipFile) === TRUE) {
            $zip->extractTo($extractPath);
            $zip->close();
        }

        echo "📂 Extracted update.\n";

        $manifest = json_decode(file_get_contents($extractPath . "/$repo-$branch/manifest.json"), true);
        if (!$manifest || !isset($manifest["files"])) {
            echo "❌ Manifest not found.\n";
            return;
        }

        foreach ($manifest["files"] as $file => $hash) {

            $localPath = __DIR__ . "/" . $file;
            $remotePath = $extractPath . "/$repo-$branch/" . $file;

            if (!file_exists($remotePath)) continue;

            if (!file_exists($localPath)) {
                // instalar novo
                copy($remotePath, $localPath);
                echo "✨ Installed new file: $file\n";
                continue;
            }

            // comparar hash para saber se foi modificado pelo usuário
            $localHash = "sha1-" . sha1_file($localPath);

            if ($localHash === $hash) {
                // seguro atualizar
                copy($remotePath, $localPath);
                echo "✔ Updated: $file\n";
            } else {
                echo "⚠ Skipped (modified by user): $file\n";
            }
        }

        file_put_contents($localVersionFile, json_encode($remote, JSON_PRETTY_PRINT));

        unlink($zipFile);
        $this->removeDirectory($extractPath);

        echo "\n🎉 Maxiter updated to v{$remote['version']}!\n";
    }

    public function selfUpdateCLI()
    {
        echo "🔍 Checking for CLI update...\n";

        $env = parse_ini_file(__DIR__ . "/env.ini", true);
        $user = isset($env['app']['UPDATE_USER']) ? $env['app']['UPDATE_USER'] : 'maxiter-php';
        $repo = isset($env['app']['UPDATE_REPO']) ? $env['app']['UPDATE_REPO'] : 'maxiter';
        $branch = isset($env['app']['UPDATE_BRANCH']) ? $env['app']['UPDATE_BRANCH'] : 'main';

        $zipUrl = "https://github.com/$user/$repo/archive/refs/heads/$branch.zip";
        $zipFile = __DIR__ . "/maxiter_cli_update.zip";
        file_put_contents($zipFile, file_get_contents($zipUrl));

        $extractPath = __DIR__ . "/update_temp_cli";
        mkdir($extractPath);

        $zip = new ZipArchive();
        if ($zip->open($zipFile) === TRUE) {
            $zip->extractTo($extractPath);
            $zip->close();
        }

        $manifestPath = $extractPath . "/$repo-$branch/manifest.json";
        $manifest = json_decode(@file_get_contents($manifestPath), true);
        if (!$manifest || !isset($manifest['files']) || !isset($manifest['files']['maxiter'])) {
            echo "❌ Manifest missing CLI entry.\n";
            @unlink($zipFile);
            $this->removeDirectory($extractPath);
            return;
        }

        $localCliPath = __DIR__ . "/maxiter";
        $remoteCliPath = $extractPath . "/$repo-$branch/maxiter";

        if (!file_exists($remoteCliPath)) {
            echo "❌ Remote CLI not found.\n";
            @unlink($zipFile);
            $this->removeDirectory($extractPath);
            return;
        }

        $expected = $manifest['files']['maxiter'];
        $localHash = file_exists($localCliPath) ? ("sha1-" . sha1_file($localCliPath)) : '';

        if (!file_exists($localCliPath)) {
            copy($remoteCliPath, $localCliPath);
            echo "✨ Installed CLI.\n";
        } else if ($localHash === $expected) {
            $bak = __DIR__ . "/maxiter.bak";
            @copy($localCliPath, $bak);
            @unlink($localCliPath);
            copy($remoteCliPath, $localCliPath);
            echo "✔ CLI updated. Backup saved at maxiter.bak\n";
        } else {
            echo "⚠ Skipped CLI (modified by user).\n";
        }

        @unlink($zipFile);
        $this->removeDirectory($extractPath);
    }
}

// Check if arguments were passed
if ($argc < 2) {

    echo
    "\nMaxiter CLI usage\n" .
        "\n" .
        "Check the Maxiter Documentation here: https://maxiter-docs.vercel.app/\n\n";

    exit(1);
}

// Instantiate the MaxiterConfiguration class
$config = new MaxiterConfiguration();

// Check if the second argument is 'new' and the third is 'controller'
if ($argv[1] === 'new' && $argv[2] === 'controller') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new controller [controller_name]";
        exit();
    }
    $config->generateController($argv[3]);
} else if ($argv[1] === 'new' && $argv[2] === 'model') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new model [model_name]";
        exit();
    }
    $config->generateModel($argv[3]);
} else if ($argv[1] === 'new' && $argv[2] === 'view') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new view [view_name] [optional: template_name]";
        exit();
    }
    if (isset($argv[4])) {
        $config->generatePage($argv[3], $argv[4]);
    } else {
        $config->generatePage($argv[3]);
    }
} else if ($argv[1] === 'new' && $argv[2] === 'log') {

    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new log [database]";
        exit();
    }
    $config->generateLogModel($argv[3]);
} else if ($argv[1] === 'new' && $argv[2] === 'table') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new table [table_name]";
        exit();
    }
    $config->generateSQL($argv[3]);
} else if ($argv[1] === 'server') {
    if (!isset($argv[2]) || empty($argv[2])) {
        $config->initServer();
    } else {
        $config->initServer($argv[2]);
    }
} else if ($argv[1] === 'gui') {
    if (!isset($argv[2]) || empty($argv[2])) {
        $config->initGUI();
    }
} else if ($argv[1] === 'path') {
    if (!isset($argv[2]) || empty($argv[2])) {
        echo "Error: php maxiter path [base_url_path] || Example: php maxiter path http://localhost/maxiter/ * Don't forget the / at the end!";
        exit();
    }
    $config->setPath($argv[2]);
} else if ($argv[1] === 'new' && $argv[2] === 'template') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new template [template_folder_name]";
        exit();
    }

    echo "Warning! This will erase all your actual /views data and set up a new configuration using the template in src/template/" . $argv[3] . ".";
    $config->setNewTemplate($argv[3]);
    // $handle = fopen("php://stdin", "r");
    // $response = trim(fgets($handle));  
    // fclose($handle);
    // if (strtolower($response) === 'y' || strtolower($response) === 'yes') {
    //     $config->setNewTemplate($argv[3]);
    // } else {
    //     echo "Operation cancelled.";
    // }
} else if ($argv[1] === 'new' && $argv[2] === 'api') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new api [api_controller_name]";
        exit();
    }
    $config->generateApiController($argv[3]);
} else if ($argv[1] === 'new' && $argv[2] === 'middleware') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new middleware [middleware_name]";
        exit();
    }
    $config->generateMiddleware($argv[3]);
} else if ($argv[1] === 'new' && $argv[2] === 'unittest') {
    if (!isset($argv[3]) || empty($argv[3]) || !isset($argv[4]) || empty($argv[4])) {
        echo "Error: php maxiter new unittest [controller_name] [function_name]";
        exit();
    }
    $config->generateUnitTest($argv[3], $argv[4]);
} else if ($argv[1] === 'testme') {
    if (!isset($argv[1]) || empty($argv[1])) {
        echo "Error: php maxiter testme";
        exit();
    }
    $config->PHPUnitTest();
} else if ($argv[1] === 'config' && $argv[2] === 'prod') {
    if (!isset($argv[1]) || empty($argv[1]) || !isset($argv[2]) || empty($argv[2])) {
        echo "Error: php maxiter config prod";
        exit();
    }
    $config->configProdEnv();
} else if ($argv[1] === 'deltoprod') {
    if (!isset($argv[1]) || empty($argv[1])) {
        echo "Error: php maxiter deltoprod";
        exit();
    }
    $config->configProdEnvDel();
} else if ($argv[1] === '-f' && $argv[2] === 'deltoprod') {
    if (!isset($argv[1]) || empty($argv[1]) || !isset($argv[2]) || empty($argv[2])) {
        echo "Error: php maxiter -f deltoprod";
        exit();
    }
    $config->configProdEnvWithFolder();
} else if ($argv[1] === 'autopath') {
    if (!isset($argv[1]) || empty($argv[1])) {
        echo "Error: php maxiter autopath [port]";
        exit();
    }
    if (isset($argv[2])) {
        $config->autoSetUpPath($argv[2]);
    } else {
        $config->autoSetUpPath();
    }
} else if ($argv[1] === 'new' && $argv[2] === 'component') {
    if (!isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter new component [component_name] [template_name]";
        exit();
    }
    if (isset($argv[4])) {
        $config->newComponent($argv[3], $argv[4]);
    } else {
        $config->newComponent($argv[3]);
    }
} else if ($argv[1] === 'mirror' && $argv[3] === 'export') {
    if (!isset($argv[1]) || empty($argv[1]) || !isset($argv[2]) || empty($argv[2]) || !isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter mirror [database_name] export";
        exit();
    }
    $config->mirrorExport($argv[2]);
} else if ($argv[1] === 'mirror' && $argv[3] === 'import') {
    if (!isset($argv[1]) || empty($argv[1]) || !isset($argv[2]) || empty($argv[2]) || !isset($argv[3]) || empty($argv[3])) {
        echo "Error: php maxiter mirror [database_name] import [date]";
        exit();
    }
    $config->mirrorImport($argv[2], isset($argv[4]) ? $argv[4] : null);
} else if ($argv[1] === 'update') {
    if (isset($argv[2]) && $argv[2] === 'cli') {
        $config->selfUpdateCLI();
    } else {
        $config->selfUpdate();
    }
} else {
    echo "Command not found\n";
}
